<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finals Strategist | Pro Esports Coach Terminal</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #d6333e;
      --accent: #fcd116; /* The Finals Yellow */
      --dark: #0f0f0f;
      --panel: #161616;
      --border: #333;
      --text: #f0f0f0;
      --text-muted: #888;
      --success: #2ecc71;
      --danger: #e74c3c;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
      margin: 0;
      font-family: 'Oswald', sans-serif;
      background-color: var(--dark);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* --- LAYOUT STRUCTURE --- */
    #sidebar-left {
      width: 300px;
      background-color: var(--panel);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      z-index: 20;
    }

    #sidebar-right {
      width: 380px; 
      background-color: var(--panel);
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      z-index: 20;
      overflow-y: auto;
    }

    #main-stage {
      flex: 1;
      position: relative;
      background: #050505;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* --- HEADER & TABS --- */
    .brand-header {
      padding: 15px;
      background: linear-gradient(90deg, #000, #1a1a1a);
      border-bottom: 2px solid var(--primary);
      text-align: center;
    }
    .brand-header h1 { margin: 0; font-style: italic; text-transform: uppercase; letter-spacing: 1px; font-size: 1.4rem; }
    /* Subtitle removed per request */

    .nav-tabs { display: flex; background: #000; border-bottom: 1px solid var(--border); }
    .nav-btn {
      flex: 1; padding: 12px 5px; background: transparent; border: none;
      color: var(--text-muted); font-weight: bold; cursor: pointer;
      text-transform: uppercase; transition: 0.2s; font-size: 0.8rem;
    }
    .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-btn.active { color: var(--accent); background: var(--panel); border-bottom: 2px solid var(--accent); }

    .content-pane { padding: 15px; overflow-y: auto; height: 100%; display: none; }
    .content-pane.active { display: block; }

    /* --- UI ELEMENTS --- */
    h3 { 
      font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; 
      border-bottom: 1px solid #333; padding-bottom: 5px; margin: 20px 0 10px 0; 
    }
    h3:first-child { margin-top: 0; }

    label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 3px; }
    select, input, textarea {
      width: 100%; padding: 6px; background: #222; border: 1px solid #333;
      color: white; font-family: 'Roboto Mono', monospace; margin-bottom: 8px; font-size: 0.8rem;
    }
    select:focus, input:focus { border-color: var(--accent); outline: none; }

    button {
      background: #2a2a2a; color: white; border: 1px solid #444;
      padding: 8px; cursor: pointer; text-transform: uppercase; font-weight: bold;
      transition: 0.2s; width: 100%; margin-bottom: 5px; font-size: 0.8rem;
    }
    button:hover { border-color: var(--primary); color: var(--primary); }
    button.btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
    button.btn-accent { background: var(--accent); border-color: var(--accent); color: black; }
    button.btn-danger { background: #4a0000; border-color: var(--danger); color: white; }
    button.btn-danger:hover { background: var(--danger); }

    /* --- GADGETS --- */
    .gadget-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .draggable-item { 
      width: 100%; aspect-ratio: 1; background-color: #222; border: 1px solid #444; border-radius: 4px;
      cursor: grab; background-size: contain; background-repeat: no-repeat; background-position: center;
      position: relative; transition: 0.2s;
    }
    .draggable-item:hover { border-color: var(--accent); transform: scale(1.05); }
    
    /* --- MAP TOKENS --- */
    #map-wrapper {
      position: absolute; transform-origin: center;
      box-shadow: 0 0 50px rgba(0,0,0,0.8);
    }
    #map-img { display: block; pointer-events: none; }
    
    .placed-token {
      position: absolute; width: 44px; height: 44px;
      transform: translate(-50%, -50%); z-index: 100; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    
    .token-icon {
      width: 100%; height: 100%; border-radius: 4px;
      background-size: cover; background-position: center;
      border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.7);
      z-index: 10; position: relative;
    }
    
    /* Vision Cone */
    .vision-cone {
      position: absolute; top: 50%; left: 50%;
      width: 250px; height: 250px;
      background: linear-gradient(to right, transparent 35%, rgba(255, 255, 255, 0.15) 50%, transparent 65%);
      clip-path: polygon(50% 50%, 0% 0%, 100% 0%);
      transform-origin: 50% 50%;
      transform: translate(-50%, -50%) rotate(0deg);
      pointer-events: none; z-index: 1;
    }

    .token-label {
      position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: var(--accent);
      font-size: 9px; white-space: nowrap; padding: 2px 4px;
      border-radius: 3px; margin-top: 2px; pointer-events: none;
      font-family: 'Roboto Mono', monospace; z-index: 20;
    }

    /* Player Specific Tokens */
    .player-token .token-icon { border-radius: 50%; border-width: 3px; display: flex; align-items: center; justify-content: center; font-weight: bold; text-shadow: 0 0 3px black; font-size: 1.2rem; }
    .token-dead .token-icon { filter: grayscale(100%); border-color: #555 !important; opacity: 0.7; }
    .token-dead .token-label { color: var(--danger); }

    /* --- RIGHT SIDEBAR (MATCH STATE) --- */
    .match-team {
      background: #1a1a1a; margin-bottom: 15px; border-top: 3px solid #555;
    }
    .match-team-header {
      padding: 10px; background: #111; display: flex; justify-content: space-between; align-items: center;
    }
    .team-name-input { 
      background: transparent; border: none; color: inherit; font-weight: bold; font-family: 'Oswald'; font-size: 1rem; width: 60%; padding: 0; margin: 0;
    }
    .team-score { font-family: 'Roboto Mono'; font-weight: bold; color: var(--accent); font-size: 1rem; }
    
    .player-row {
      display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #2a2a2a;
      font-size: 0.85rem; cursor: grab; background: #1a1a1a;
      transition: background 0.2s;
    }
    .player-row:hover { background: #252525; }
    .player-row:active { cursor: grabbing; }

    .player-name-input {
      background: transparent; border: none; border-bottom: 1px solid transparent; color: inherit; font-weight: bold; 
      width: 100%; margin: 0 5px; padding: 2px;
    }
    .player-name-input:focus { border-bottom: 1px solid var(--accent); }

    .p-status {
      width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; cursor: pointer;
      border: 1px solid #555; background: #000;
    }
    .p-status.alive { background: var(--success); box-shadow: 0 0 5px var(--success); border-color: var(--success); }
    .p-status.dead { background: var(--danger); border-color: var(--danger); }
    
    .class-selector {
      width: 40px; margin: 0 5px 0 0; padding: 2px; font-size: 0.8rem; text-align: center;
    }

    /* --- ECONOMY PANEL --- */
    .eco-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px; }
    .eco-btn { font-size: 0.75rem; padding: 6px; }
    .eco-label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 2px; border-bottom: 1px solid #333; margin-top: 5px;}

    /* --- LOADOUT BUILDER --- */
    .loadout-container { border: 1px solid #333; padding: 10px; margin-bottom: 10px; background: #222; }
    .preset-manager { background: #111; padding: 10px; margin-bottom: 15px; border: 1px solid #333; }

    /* --- ROTATION CONTROLS (Floating) --- */
    #rotation-control {
      position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.9); padding: 10px; border-radius: 8px;
      display: none; z-index: 200; border: 1px solid var(--accent);
      text-align: center; min-width: 220px;
    }
    input[type=range] { width: 100%; accent-color: var(--accent); margin-bottom: 10px; }

    /* --- VIDEO OVERLAY --- */
    #video-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #000; z-index: 9999; display: none;
      flex-direction: column;
    }
    #video-overlay.active { display: flex; }
    .video-toolbar { padding: 10px; background: #111; display: flex; gap: 10px; border-bottom: 1px solid #333; }
    #video-frame { flex: 1; width: 100%; border: none; }

    .wiki-credit {
      margin-top: auto; padding: 10px; font-size: 0.7rem; color: #555;
      text-align: center; border-top: 1px solid #222;
    }
    .wiki-credit a { color: #666; text-decoration: none; }

    /* Drawing Canvas */
    #draw-layer { position: absolute; top:0; left:0; pointer-events: none; }
  </style>
</head>
<body>

<div id="sidebar-left">
  <div class="brand-header">
    <h1>Finals Strategist</h1>
  </div>

  <div class="nav-tabs">
    <button class="nav-btn active" onclick="setTab('tools')">Tools & Map</button>
    <button class="nav-btn" onclick="setTab('loadout')">My Loadout</button>
  </div>

  <div id="tab-tools" class="content-pane active">
    <h3>Map Selection</h3>
    <select id="map-select" onchange="loadMap(this.value)"></select>

    <h3>Tactical Drawing</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap:5px;">
      <button onclick="setTool('pen')">‚úèÔ∏è Pen</button>
      <button onclick="setTool('arrow')">‚Üó Arrow</button>
      <button onclick="clearDraw()" style="color:var(--danger); border-color: #500;">üóë Clear Draw</button>
      <button onclick="clearTokens()" style="color:var(--danger); border-color: #500;">‚ùå Clear Icons</button>
    </div>

    <h3>Objectives</h3>
    <div class="gadget-grid">
      <div class="draggable-item" draggable="true" data-type="obj" data-name="Cashout" data-src="cashout.png" style="background-image: url('cashout.png'); background-color:var(--primary);"></div>
      <div class="draggable-item" draggable="true" data-type="obj" data-name="Vault" data-src="vault.png" style="background-image: url('vault.png'); background-color:var(--accent);"></div>
    </div>

    <h3>Utility & Gadgets</h3>
    <div class="gadget-grid" id="gadget-palette">
      </div>

    <div style="margin-top: 20px; font-size: 0.8rem; color: #666; font-style: italic;">
      ‚ÑπÔ∏è Drag Players from the <strong>Scoreboard (Right)</strong> to the map. <br>
      ‚ÑπÔ∏è Click a token on map to Rotate or Delete it.
    </div>
  </div>

  <div id="tab-loadout" class="content-pane">
    <button class="btn-accent" onclick="document.getElementById('video-overlay').classList.add('active')">üé¨ Open Theater Mode</button>
    
    <h3>My Team Strategy</h3>
    
    <div class="preset-manager">
      <label>Strategy / Map Preset Name</label>
      <input type="text" id="preset-name" placeholder="e.g., Monaco - Church Def">
      <div style="display:flex; gap:5px;">
        <button class="btn-primary" onclick="saveLoadoutPreset()">üíæ Save Preset</button>
        <button onclick="loadPresetPrompt()">üìÇ Load...</button>
      </div>
    </div>

    <div id="loadout-editor">
      </div>
  </div>

  <div class="wiki-credit">
    Assets used from <br>
    <a href="https://www.thefinals.wiki/" target="_blank">https://www.thefinals.wiki/</a> <br>
    Images ¬© Embark Studios.
  </div>
</div>

<div id="main-stage">
  <div id="map-wrapper">
    <img id="map-img" src="" alt="Select Map">
    <canvas id="draw-layer"></canvas>
    <div id="icon-layer"></div>
  </div>

  <div id="rotation-control" onmousedown="event.stopPropagation()">
    <div style="color:white; font-size:0.8rem; margin-bottom:5px;">ADJUST PERSPECTIVE</div>
    <input type="range" id="vision-slider" min="0" max="360" value="0" oninput="rotateVision(this.value)">
    <button class="btn-danger" style="margin:0;" onclick="deleteActiveToken()">üóë Remove Token</button>
  </div>
  
  <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display:flex; gap:10px;">
    <button style="width:40px; border-radius:50%;" onclick="zoom(1.1)">+</button>
    <button style="width:40px; border-radius:50%;" onclick="zoom(0.9)">-</button>
    <button style="width:40px; border-radius:50%;" onclick="resetView()">R</button>
  </div>
</div>

<div id="sidebar-right">
  <div style="padding:15px; border-bottom:1px solid #333;">
    <label>Game Mode</label>
    <select id="game-mode-select" onchange="renderMatchState()">
      <option value="cashout">Cashout (3v3v3v3)</option>
      <option value="final">Final Round (3v3)</option>
    </select>
  </div>

  <div id="scoreboard-container" style="padding:10px;">
    </div>

  <div id="economy-panel" style="padding:15px; margin-top:auto; border-top:1px solid #333;">
    <h3 style="margin:0 0 10px 0;">Economy Control</h3>
    
    <div class="eco-label">Combat & Objectives</div>
    <div class="eco-grid">
      <button class="eco-btn" onclick="ecoEvent('kill')">Kill (+$500)</button>
      <button class="eco-btn" onclick="ecoEvent('open_vault')">Open Vault (+$1k)</button>
      <button class="eco-btn" onclick="ecoEvent('steal')">Steal (+$1k)</button>
      <button class="eco-btn" onclick="ecoEvent('revive')">Revive</button>
    </div>

    <div class="eco-label">Deposits (Start Cashout)</div>
    <div class="eco-grid" style="grid-template-columns: 1fr 1fr 1fr;">
      <button class="eco-btn btn-primary" onclick="ecoEvent('dep_1')">V 1/2<br>($2k)</button>
      <button class="eco-btn btn-primary" onclick="ecoEvent('dep_2')">V 3/4<br>($3k)</button>
      <button class="eco-btn btn-primary" onclick="ecoEvent('dep_3')">V 5/6<br>($4k)</button>
    </div>

    <div class="eco-label">Cashout Complete</div>
    <div class="eco-grid" style="grid-template-columns: 1fr 1fr 1fr;">
      <button class="eco-btn btn-accent" onclick="ecoEvent('fin_1')">$10k</button>
      <button class="eco-btn btn-accent" onclick="ecoEvent('fin_2')">$15k</button>
      <button class="eco-btn btn-accent" onclick="ecoEvent('fin_3')">$22k</button>
    </div>

    <div style="margin-top:10px; font-size:0.7rem; color:#666; text-align:center;">
      Select Team Header above to apply cash events.
    </div>
  </div>
</div>

<div id="video-overlay">
  <div class="video-toolbar">
    <input type="text" id="video-url" placeholder="Paste YouTube Embed URL (e.g., https://www.youtube.com/embed/VIDEO_ID)" style="margin:0; flex:1;">
    <button onclick="loadVideo()" style="width:auto; margin:0;" class="btn-primary">Load</button>
    <button onclick="document.getElementById('video-overlay').classList.remove('active')" style="width:auto; margin:0; border-color:var(--danger); color:var(--danger);">Close X</button>
  </div>
  <iframe id="video-frame" src="" allowfullscreen></iframe>
</div>

<script>
  // --- DATA ---
  const mapData = {
    "Kyoto": "Kyoto.png", "Seoul": "Seoul.png", "Monaco": "Monaco.png",
    "Skyway Stadium": "Skyway Stadium.png", "SysHorizon": "SysHorizon.png",
    "Fortune Stadium": "Fortune Stadium.png", "Bernal": "Bernal.png"
  };

  // Removed Defibrillator per request
  const gadgetDB = [
    { name: "Dome Shield", url: "https://www.thefinals.wiki/w/images/thumb/c/cd/Dome_Shield_Rank_1.png/100px-Dome_Shield_Rank_1.png.webp" },
    { name: "RPG-7", url: "https://www.thefinals.wiki/w/images/thumb/7/7a/RPG-7_Rank_1.png/100px-RPG-7_Rank_1.png.webp" },
    { name: "Zipline", url: "https://www.thefinals.wiki/w/images/thumb/4/49/Zipline_Rank_1.png/100px-Zipline_Rank_1.png.webp" },
    { name: "Jump Pad", url: "https://www.thefinals.wiki/w/images/thumb/e/ef/Jump_Pad_Rank_1.png/100px-Jump_Pad_Rank_1.png.webp" },
    { name: "Glitch Grenade", url: "https://www.thefinals.wiki/w/images/thumb/b/b5/Glitch_Grenade_Rank_1.png/100px-Glitch_Grenade_Rank_1.png.webp" },
    { name: "Gateway", url: "https://www.thefinals.wiki/w/images/thumb/c/c4/Gateway_Rank_1.png/100px-Gateway_Rank_1.png.webp" },
    { name: "Goo Grenade", url: "https://www.thefinals.wiki/w/images/thumb/9/93/Goo_Grenade_Rank_1.png/100px-Goo_Grenade_Rank_1.png.webp" }
  ];

  // Data from
  const classData = {
    Light: {
      specs: ["Grappling Hook", "Evasive Dash", "Cloaking Device"],
      weapons: ["M11", "XP-54", "V9S", "LH1", "SR-84", "Sword", "Throwing Knives"],
      gadgets: ["Glitch Grenade", "Stun Gun", "Vanishing Bomb", "Gateway", "Thermal Bore", "Breach Charge"]
    },
    Medium: {
      specs: ["Healing Beam", "Guardian Turret", "Dematerializer"],
      weapons: ["AKM", "FCAR", "Model 1887", "CL-40", "R.357", "FAMAS", "Dual Blades"],
      gadgets: ["Defibrillator", "Jump Pad", "Zipline", "APS Turret", "Glitch Trap", "Explosive Mine"]
    },
    Heavy: {
      specs: ["Mesh Shield", "Charge 'N' Slam", "Goo Gun", "Winch Claw"],
      weapons: ["Lewis Gun", "M60", "SA1216", "Sledgehammer", "Flamethrower", "Spear"],
      gadgets: ["RPG-7", "Dome Shield", "Barricade", "C4", "Anti-Gravity Cube", "Pyro Grenade"]
    }
  };

  const teams = [
    { name: "Vogues (My Team)", color: "#FF69B4", cash: 0, players: [ {c:'L', n:'Me'}, {c:'M', n:'Teammate 1'}, {c:'H', n:'Teammate 2'} ] },
    { name: "Steamers (Orange)", color: "#FFA500", cash: 0, players: [ {c:'H', n:'Enemy 1'}, {c:'H', n:'Enemy 2'}, {c:'M', n:'Enemy 3'} ] },
    { name: "Socialites (Purple)", color: "#9370DB", cash: 0, players: [ {c:'M', n:'Enemy 1'}, {c:'M', n:'Enemy 2'}, {c:'M', n:'Enemy 3'} ] },
    { name: "Kingfish (Blue)", color: "#00BFFF", cash: 0, players: [ {c:'L', n:'Enemy 1'}, {c:'L', n:'Enemy 2'}, {c:'H', n:'Enemy 3'} ] }
  ];

  // Global State
  let scale = 0.5, pX = 0, pY = 0;
  let currentTool = null, isDragging = false, startX, startY, ctx;
  let selectedTeamIdx = 0;
  let activeTokenId = null; // For rotation/deletion

  // --- INITIALIZATION ---
  function init() {
    // 1. Populate Maps
    const ms = document.getElementById('map-select');
    for(let m in mapData) { let opt = document.createElement('option'); opt.value = mapData[m]; opt.text = m; ms.appendChild(opt); }
    if(ms.options.length > 0) loadMap(ms.options[0].value);

    // 2. Populate Gadgets
    const gp = document.getElementById('gadget-palette');
    gadgetDB.forEach(g => {
      const div = document.createElement('div');
      div.className = 'draggable-item';
      div.style.backgroundImage = `url('${g.url}')`;
      div.draggable = true;
      div.title = g.name;
      div.dataset.type = 'gadget';
      div.dataset.name = g.name;
      div.dataset.src = g.url;
      gp.appendChild(div);
    });

    // 3. Render Initial State
    renderLoadoutEditor();
    renderMatchState();
    setupInteractions();
  }

  // --- RENDERERS ---

  function renderLoadoutEditor() {
    const container = document.getElementById('loadout-editor');
    container.innerHTML = '';
    
    // Strict focus on Team 0
    const t = teams[0];
    t.players.forEach((p, pIdx) => {
      if(!p.loadout) p.loadout = { spec: '', wep: '', g1: '', g2: '', g3: '' };
      const cData = classData[p.c === 'L' ? 'Light' : p.c === 'M' ? 'Medium' : 'Heavy'];

      const slot = document.createElement('div');
      slot.className = 'loadout-container';
      slot.style.borderLeft = `4px solid ${t.color}`;
      
      slot.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
           <span style="font-weight:bold; color:${t.color}">Player ${pIdx+1} (${p.c})</span>
           <span style="font-size:0.7rem; color:#888;">${p.n}</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <div>
            <label>Specialization</label>
            <select onchange="updateLoadout(${pIdx},'spec',this.value)">${createOptions(cData.specs, p.loadout.spec)}</select>
          </div>
          <div>
            <label>Weapon</label>
            <select onchange="updateLoadout(${pIdx},'wep',this.value)">${createOptions(cData.weapons, p.loadout.wep)}</select>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
           <select onchange="updateLoadout(${pIdx},'g1',this.value)">${createOptions(cData.gadgets, p.loadout.g1)}</select>
           <select onchange="updateLoadout(${pIdx},'g2',this.value)">${createOptions(cData.gadgets, p.loadout.g2)}</select>
           <select onchange="updateLoadout(${pIdx},'g3',this.value)">${createOptions(cData.gadgets, p.loadout.g3)}</select>
        </div>
      `;
      container.appendChild(slot);
    });
  }

  function createOptions(arr, current) {
    return `<option value="">- Select -</option>` + arr.map(item => `<option value="${item}" ${item===current?'selected':''}>${item}</option>`).join('');
  }

  function renderMatchState() {
    const container = document.getElementById('scoreboard-container');
    container.innerHTML = '';
    const mode = document.getElementById('game-mode-select').value;
    const limit = mode === 'cashout' ? 4 : 2;

    // Toggle Economy Panel
    const ecoPanel = document.getElementById('economy-panel');
    if(mode === 'final') ecoPanel.style.display = 'none';
    else ecoPanel.style.display = 'block';

    for(let i=0; i<limit; i++) {
      const t = teams[i];
      const div = document.createElement('div');
      div.className = 'match-team';
      div.style.borderTopColor = t.color;
      if(selectedTeamIdx === i) div.style.boxShadow = `0 0 8px ${t.color}`;

      let html = `
        <div class="match-team-header" onclick="selectTeam(${i})" style="cursor:pointer">
          <input class="team-name-input" style="color:${t.color};" value="${t.name}" onchange="updateTeamName(${i}, this.value)" onclick="event.stopPropagation()">
          <span class="team-score">$${t.cash.toLocaleString()}</span>
        </div>
      `;

      t.players.forEach((p, pIdx) => {
        const statusClass = (p.status === 'dead') ? 'dead' : 'alive';
        const lSel = p.c === 'L' ? 'selected' : '';
        const mSel = p.c === 'M' ? 'selected' : '';
        const hSel = p.c === 'H' ? 'selected' : '';

        html += `
          <div class="player-row" draggable="true" 
               data-type="player" data-tidx="${i}" data-pidx="${pIdx}" 
               ondragstart="handleDragStart(event)">
            
            <div class="p-status ${statusClass}" onclick="toggleStatus(${i}, ${pIdx})"></div>
            
            <select class="class-selector" onchange="changeClass(${i}, ${pIdx}, this.value)" onclick="event.stopPropagation()">
                <option value="L" ${lSel}>L</option>
                <option value="M" ${mSel}>M</option>
                <option value="H" ${hSel}>H</option>
            </select>

            <input class="player-name-input" style="color:${t.color};" value="${p.n}" onchange="updatePlayerName(${i}, ${pIdx}, this.value)" onclick="event.stopPropagation()">
            
            <input type="number" value="${p.k || 0}" style="width:30px; margin:0;" onchange="updateStat(${i},${pIdx},'k',this.value)" onclick="event.stopPropagation()" placeholder="K">
          </div>
        `;
      });
      div.innerHTML = html;
      container.appendChild(div);
    }
  }

  // --- LOGIC ---
  function updateTeamName(i, val) { teams[i].name = val; }
  function updatePlayerName(tIdx, pIdx, val) { 
    teams[tIdx].players[pIdx].n = val; 
    if(tIdx === 0) renderLoadoutEditor();
  }
  
  function updateLoadout(pIdx, field, val) { 
    teams[0].players[pIdx].loadout[field] = val; 
  }
  
  function saveLoadoutPreset() {
    const name = document.getElementById('preset-name').value;
    if(!name) return alert('Enter a preset name');
    const data = JSON.stringify(teams[0].players);
    localStorage.setItem('tf_loadout_' + name, data);
    alert('Preset "' + name + '" saved!');
  }

  function loadPresetPrompt() {
    const name = prompt("Enter exact preset name to load:");
    if(!name) return;
    const data = localStorage.getItem('tf_loadout_' + name);
    if(data) {
        teams[0].players = JSON.parse(data);
        renderLoadoutEditor();
        renderMatchState();
    } else {
        alert("Preset not found");
    }
  }

  function changeClass(tIdx, pIdx, newClass) {
    teams[tIdx].players[pIdx].c = newClass;
    if(tIdx === 0) renderLoadoutEditor();
    const tokens = document.querySelectorAll(`.placed-token[data-ref="${tIdx}-${pIdx}"] .token-icon`);
    tokens.forEach(el => el.innerText = newClass);
  }

  function updateStat(t, p, field, val) { teams[t].players[p][field] = parseInt(val); }
  function selectTeam(i) { selectedTeamIdx = i; renderMatchState(); }
  
  function toggleStatus(t, p) {
    const player = teams[t].players[p];
    player.status = player.status === 'dead' ? 'alive' : 'dead';
    if(player.status === 'dead') player.d = (player.d || 0) + 1;
    renderMatchState();
    updateMapTokenVisuals(t, p);
  }

  function ecoEvent(type) {
    if(selectedTeamIdx === null) return;
    const t = teams[selectedTeamIdx];
    
    // Cash Rules
    if(type === 'kill') t.cash += 500;
    if(type === 'open_vault') t.cash += 1000;
    if(type === 'steal') t.cash += 1000;
    
    // Deposit Logic (20% of Value)
    if(type === 'dep_1') t.cash += 2000; 
    if(type === 'dep_2') t.cash += 3000; 
    if(type === 'dep_3') t.cash += 4400; 

    // Completion Logic (80% of Value)
    if(type === 'fin_1') t.cash += 10000; 
    if(type === 'fin_2') t.cash += 15000; 
    if(type === 'fin_3') t.cash += 22000; 
    
    renderMatchState();
  }

  function updateMapTokenVisuals(tIdx, pIdx) {
    const tokens = document.querySelectorAll(`.placed-token[data-ref="${tIdx}-${pIdx}"]`);
    const isDead = teams[tIdx].players[pIdx].status === 'dead';
    tokens.forEach(tok => {
      if(isDead) tok.classList.add('token-dead');
      else tok.classList.remove('token-dead');
    });
  }

  // --- MAP & DRAG ---
  function loadMap(src) {
    const img = document.getElementById('map-img');
    img.onload = () => {
       const cvs = document.getElementById('draw-layer');
       cvs.width = img.naturalWidth; cvs.height = img.naturalHeight;
       resetView();
    };
    img.src = src;
    document.getElementById('icon-layer').innerHTML = ''; 
  }

  function handleDragStart(e) {
    const t = e.target.closest('.player-row');
    const tIdx = t.dataset.tidx;
    const pIdx = t.dataset.pidx;
    const player = teams[tIdx].players[pIdx];
    const team = teams[tIdx];

    const payload = {
        type: 'player',
        tIdx: tIdx,
        pIdx: pIdx,
        label: player.c,
        bg: team.color,
        name: player.n
    };
    e.dataTransfer.setData('json', JSON.stringify(payload));
    e.dataTransfer.setData('mode', 'new');
  }

  function setupInteractions() {
    const stage = document.getElementById('main-stage');
    
    document.addEventListener('dragstart', e => {
      if(e.target.classList.contains('player-row')) return;
      
      const t = e.target;
      if(t.classList.contains('draggable-item')) {
        const payload = {
          type: t.dataset.type,
          name: t.dataset.name,
          src: t.dataset.src
        };
        e.dataTransfer.setData('json', JSON.stringify(payload));
        e.dataTransfer.setData('mode', 'new');
      } else if (t.closest('.placed-token')) {
        const tok = t.closest('.placed-token');
        e.dataTransfer.setData('mode', 'move');
        e.dataTransfer.setData('id', tok.id);
      }
    });

    const wrapper = document.getElementById('map-wrapper');
    wrapper.addEventListener('dragover', e => e.preventDefault());
    wrapper.addEventListener('drop', e => {
      e.preventDefault();
      const rect = wrapper.getBoundingClientRect();
      const x = (e.clientX - rect.left) / scale;
      const y = (e.clientY - rect.top) / scale;
      
      const mode = e.dataTransfer.getData('mode');
      if(mode === 'new') {
        const raw = e.dataTransfer.getData('json');
        if(raw) createToken(x, y, JSON.parse(raw));
      } else if (mode === 'move') {
        const id = e.dataTransfer.getData('id');
        const el = document.getElementById(id);
        if(el) { el.style.left = x + 'px'; el.style.top = y + 'px'; }
      }
    });

    stage.addEventListener('mousedown', onMouseDown);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
    stage.addEventListener('wheel', e => {
      e.preventDefault();
      scale += e.deltaY * -0.001;
      scale = Math.min(Math.max(0.1, scale), 4);
      updateTransform();
    });
  }

  function createToken(x, y, data) {
    const div = document.createElement('div');
    div.className = 'placed-token';
    div.id = 'tok-' + Date.now();
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    div.draggable = true;
    
    div.onclick = (e) => {
        e.stopPropagation();
        selectTokenForRotation(div.id);
    };

    const icon = document.createElement('div');
    icon.className = 'token-icon';

    if(data.type === 'gadget' || data.type === 'obj') {
      icon.style.backgroundImage = `url('${data.src}')`; 
      icon.style.backgroundColor = 'rgba(0,0,0,0.5)';
      icon.style.borderColor = data.name === 'Cashout' ? 'var(--primary)' : 'var(--accent)';
      
      const label = document.createElement('div');
      label.className = 'token-label';
      label.innerText = data.name;
      div.appendChild(label);
    } 
    else if (data.type === 'player') {
      div.classList.add('player-token');
      div.dataset.ref = `${data.tIdx}-${data.pIdx}`;
      icon.style.backgroundColor = data.bg;
      icon.innerText = data.label;
      icon.style.color = 'white';
      
      const cone = document.createElement('div');
      cone.className = 'vision-cone';
      div.appendChild(cone);

      if(teams[data.tIdx].players[data.pIdx].status === 'dead') div.classList.add('token-dead');
    }

    div.appendChild(icon);
    div.addEventListener('contextmenu', e => { e.preventDefault(); div.remove(); document.getElementById('rotation-control').style.display='none'; });
    document.getElementById('icon-layer').appendChild(div);
  }

  // --- VISION & ROTATION ---
  function selectTokenForRotation(id) {
    activeTokenId = id;
    const el = document.getElementById(id);
    document.getElementById('rotation-control').style.display = 'block';
    
    const cone = el.querySelector('.vision-cone');
    if(!cone) {
        document.getElementById('vision-slider').style.display = 'none';
    } else {
        document.getElementById('vision-slider').style.display = 'block';
        document.getElementById('vision-slider').value = el.dataset.rotation || 0;
    }
  }

  function deleteActiveToken() {
    if(activeTokenId) {
        document.getElementById(activeTokenId).remove();
        document.getElementById('rotation-control').style.display = 'none';
        activeTokenId = null;
    }
  }

  function rotateVision(val) {
    if(!activeTokenId) return;
    const el = document.getElementById(activeTokenId);
    el.dataset.rotation = val;
    const cone = el.querySelector('.vision-cone');
    if(cone) cone.style.transform = `translate(-50%, -50%) rotate(${val}deg)`;
  }

  // --- DRAWING & PANNING ---
  function getCtx() { return document.getElementById('draw-layer').getContext('2d'); }
  function setTool(t) { currentTool = t; document.getElementById('main-stage').style.cursor = t ? 'crosshair' : 'default'; }
  function clearDraw() { const c = document.getElementById('draw-layer'); c.getContext('2d').clearRect(0, 0, c.width, c.height); }
  function clearTokens() { document.getElementById('icon-layer').innerHTML = ''; document.getElementById('rotation-control').style.display='none'; }

  function onMouseDown(e) {
    if(e.target.closest('.placed-token')) return;
    document.getElementById('rotation-control').style.display = 'none';
    
    isDragging = true;
    if(currentTool) {
      const r = document.getElementById('map-wrapper').getBoundingClientRect();
      startX=(e.clientX-r.left)/scale; startY=(e.clientY-r.top)/scale;
      ctx=getCtx(); ctx.strokeStyle=currentTool==='arrow'?'#fcd116':'#d6333e'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(startX,startY);
    } else {
      startX = e.clientX - pX; startY = e.clientY - pY;
    }
  }

  function onMouseMove(e) {
    if(!isDragging) return;
    if(currentTool) {
       const r=document.getElementById('map-wrapper').getBoundingClientRect(), mx=(e.clientX-r.left)/scale, my=(e.clientY-r.top)/scale;
       if(currentTool==='pen'){ ctx.lineTo(mx,my); ctx.stroke(); }
    } else {
       e.preventDefault(); pX=e.clientX-startX; pY=e.clientY-startY; updateTransform();
    }
  }

  function onMouseUp(e) {
    if(!isDragging) return; isDragging=false;
    if(currentTool) {
       const r=document.getElementById('map-wrapper').getBoundingClientRect(), mx=(e.clientX-r.left)/scale, my=(e.clientY-r.top)/scale;
       if(currentTool==='arrow') drawArrow(ctx,startX,startY,mx,my);
       ctx.closePath();
    }
  }

  function drawArrow(ctx,fx,fy,tx,ty){ 
    const head=15, dx=tx-fx, dy=ty-fy, angle=Math.atan2(dy,dx); 
    ctx.moveTo(fx,fy); ctx.lineTo(tx,ty); 
    ctx.lineTo(tx-head*Math.cos(angle-Math.PI/6),ty-head*Math.sin(angle-Math.PI/6)); 
    ctx.moveTo(tx,ty); 
    ctx.lineTo(tx-head*Math.cos(angle+Math.PI/6),ty-head*Math.sin(angle+Math.PI/6)); 
    ctx.stroke(); 
  }

  function updateTransform() { document.getElementById('map-wrapper').style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }
  function resetView() { scale=0.5; pX=0; pY=0; updateTransform(); }
  function zoom(val) { scale*=val; updateTransform(); }

  // --- HELPERS ---
  function setTab(id) {
    document.querySelectorAll('.nav-btn, .content-pane').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    event.target.classList.add('active');
  }

  function loadVideo() {
    const url = document.getElementById('video-url').value;
    document.getElementById('video-frame').src = url;
  }

  // Start
  init();

</script>
</body>
</html>
