<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Finals Strategy | Pro Esports Coach Terminal</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --primary: #d6333e;
      --primary-hover: #b02a33;
      --accent: #fcd116; 
      --dark: #090909;
      --panel: #121212;
      --panel-border: #2a2a2a;
      --text: #f0f0f0;
      --text-muted: #888;
      --success: #2ecc71;
      --danger: #e74c3c;
      --info: #3498db;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 999px;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Oswald', sans-serif;
      background-color: var(--dark);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: var(--dark); }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* --- LAYOUT --- */
    #app-container { display: flex; width: 100%; height: 100%; position: relative; }

    .sidebar {
      background-color: var(--panel);
      display: flex;
      flex-direction: column;
      z-index: 30;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-right: 1px solid var(--panel-border);
    }

    #sidebar-left { width: 340px; flex-shrink: 0; }
    #sidebar-right { width: 360px; flex-shrink: 0; border-left: 1px solid var(--panel-border); border-right: none; }

    #main-stage {
      flex: 1;
      position: relative;
      background: #050505;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
    }

    /* --- MOBILE --- */
    .mobile-toggle { display: none; }
    
    @media (max-width: 1024px) {
      .sidebar {
        position: absolute; top: 0; bottom: 0; height: 100%;
        background: rgba(18, 18, 18, 0.98);
        backdrop-filter: blur(12px);
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
      }
      #sidebar-left { left: 0; transform: translateX(-100%); width: 300px; }
      #sidebar-left.open { transform: translateX(0); }
      
      #sidebar-right { right: 0; transform: translateX(100%); width: 320px; }
      #sidebar-right.open { transform: translateX(0); }

      .mobile-toggle {
        display: flex; position: absolute; top: 12px; z-index: 50;
        background: var(--panel); border: 1px solid var(--panel-border);
        color: white; padding: 8px; border-radius: var(--radius-md); cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      }
      #toggle-left { left: 12px; }
      #toggle-right { right: 12px; }
    }

    /* --- HEADER --- */
    .brand-header {
      padding: 20px;
      background: linear-gradient(180deg, #1a1a1a, #121212);
      border-bottom: 2px solid var(--primary);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .brand-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .brand-header h1 { margin: 0; font-style: italic; text-transform: uppercase; letter-spacing: 1px; font-size: 1.3rem; color:white; }
    .credits-sub { font-size: 0.65rem; color: #666; font-family: 'Roboto Mono'; margin-top: -2px; }
    
    /* Improved Login Button */
    .auth-btn {
      font-size: 0.75rem; padding: 8px 16px; 
      background: #222; 
      border: 1px solid #333; color: #ccc; cursor: pointer;
      border-radius: var(--radius-full); display: flex; align-items: center; gap: 6px;
      transition: all 0.2s; font-family: 'Roboto Mono', monospace; width: auto; margin:0;
    }
    .auth-btn:hover { border-color: var(--primary); color: white; background: #2a2a2a; }

    /* --- TABS --- */
    .nav-tabs { display: flex; background: #000; border-bottom: 1px solid var(--panel-border); padding: 0 5px; gap: 2px; }
    .nav-btn {
      flex: 1; padding: 12px 2px; background: transparent; border: none;
      color: var(--text-muted); font-weight: bold; cursor: pointer;
      text-transform: uppercase; transition: 0.2s; font-size: 0.7rem;
      border-bottom: 3px solid transparent; letter-spacing: 0.5px;
      border-radius: 6px 6px 0 0; display: flex; flex-direction: column; align-items: center; gap:4px;
    }
    .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.03); }
    .nav-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: var(--panel); }

    .content-pane { padding: 20px; overflow-y: auto; height: 100%; display: none; padding-bottom: 120px; }
    .content-pane.active { display: block; animation: fadeIn 0.3s cubic-bezier(0.2, 0, 0.2, 1); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- UI ELEMENTS --- */
    h3 { 
      font-size: 0.75rem; color: var(--accent); text-transform: uppercase; 
      border-bottom: 1px solid #333; padding-bottom: 8px; margin: 24px 0 12px 0; 
      letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;
    }
    h3:first-child { margin-top: 0; }

    label { font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;}
    
    select, input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 10px 12px; background: #181818; border: 1px solid #333;
      color: white; font-family: 'Roboto Mono', monospace; margin-bottom: 8px; font-size: 0.8rem;
      border-radius: var(--radius-md); transition: all 0.2s;
    }
    select:focus, input:focus { border-color: var(--accent); outline: none; background: #222; box-shadow: 0 0 0 2px rgba(252, 209, 22, 0.1); }

    /* Color Presets */
    .color-presets { display: flex; gap: 8px; margin-bottom: 0; flex: 1; justify-content: flex-end; align-items: center; }
    .color-btn {
        width: 26px; height: 26px; border-radius: 50%; border: 2px solid #333; cursor: pointer; transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .color-btn:hover { transform: scale(1.1); }
    .color-btn.active { border-color: white; box-shadow: 0 0 0 2px var(--accent); transform: scale(1.1); }

    .color-picker-wrapper {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid #444; overflow: hidden; position: relative; cursor: pointer;
      display: inline-block;
    }
    .color-picker-wrapper:hover { border-color: var(--accent); }
    input[type="color"] {
      -webkit-appearance: none; border: none; width: 150%; height: 150%; padding: 0; background: none; cursor: pointer;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }

    button {
      background: #252525; color: white; border: 1px solid #3a3a3a;
      padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold;
      transition: all 0.2s; width: 100%; margin-bottom: 8px; font-size: 0.8rem;
      border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    button:hover { border-color: var(--primary); color: var(--primary); background: #2a2a2a; transform: translateY(-1px); }
    button:active { transform: scale(0.98); }
    
    button.btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
    button.btn-primary:hover { background: var(--primary-hover); color: white; }
    
    button.btn-accent { background: var(--accent); border-color: var(--accent); color: black; }
    button.btn-accent:hover { background: #e0b800; color: black; }
    
    button.btn-danger { background: rgba(231, 76, 60, 0.1); border-color: var(--danger); color: var(--danger); }
    button.btn-danger:hover { background: var(--danger); color: white; }

    button.btn-tool { width: auto; flex: 1; padding: 10px; font-size: 0.9rem; }
    button.btn-tool.active { background: var(--accent); color: black; border-color: var(--accent); box-shadow: 0 0 10px rgba(252, 209, 22, 0.3); }
    
    /* --- TACTIC TOOLBAR STYLES --- */
    .tactic-toolbar {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      background: #151515; padding: 12px; border-radius: var(--radius-lg); 
      border: 1px solid #2a2a2a; margin-bottom: 12px;
    }
    
    .tool-group {
      display: flex; gap: 6px; background: #0a0a0a; padding: 6px; 
      border-radius: var(--radius-md); border: 1px solid #222;
    }
    
    .toolbar-btn {
      width: 38px; height: 38px; border-radius: var(--radius-sm); 
      background: transparent; border: 1px solid transparent; color: #888;
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; transition: all 0.2s; padding: 0; margin: 0;
    }
    .toolbar-btn:hover { background: #222; color: white; }
    .toolbar-btn.active { background: var(--accent); color: black; border-color: var(--accent); box-shadow: 0 0 15px rgba(252, 209, 22, 0.2); }
    
    .rec-btn-wrapper { margin-left: 5px; position: relative; }
    .toolbar-rec-btn {
        width: 50px; height: 38px; border-radius: var(--radius-full); 
        background: #1a1a1a; border: 2px solid #333; color: #666;
        display: flex; align-items: center; justify-content: center; gap: 4px;
        cursor: pointer; transition: all 0.3s; margin: 0; padding: 0 8px;
    }
    .toolbar-rec-btn:hover { border-color: #555; color: white; }
    .toolbar-rec-btn.active { 
        background: var(--danger); border-color: var(--danger); color: white; 
        box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
    }
    .rec-text { font-size: 0.6rem; font-weight: bold; letter-spacing: 1px; }

    .help-bar {
        background: #111; border-left: 3px solid var(--accent);
        padding: 10px 12px; margin-bottom: 12px; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        font-size: 0.75rem; color: #ccc; line-height: 1.4;
        display: none; animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .help-bar strong { color: var(--accent); display: block; margin-bottom: 2px; font-size: 0.8rem; }


    /* --- GADGETS --- */
    .gadget-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .draggable-item { 
      width: 100%; aspect-ratio: 1; background-color: #1a1a1a; border: 1px solid #333; border-radius: var(--radius-lg);
      cursor: grab; background-size: contain; background-repeat: no-repeat; background-position: center;
      position: relative; transition: 0.2s; overflow: hidden;
    }
    .draggable-item:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    
    /* --- MAP TOKENS --- */
    #map-wrapper {
      position: absolute; transform-origin: center;
      box-shadow: 0 0 100px rgba(0,0,0,0.9);
      cursor: grab;
      will-change: transform;
    }
    #map-wrapper:active { cursor: grabbing; }
    #map-img { display: block; pointer-events: none; user-select: none; -webkit-user-drag: none; }
    
    .placed-token {
      position: absolute; width: 48px; height: 48px;
      transform: translate(-50%, -50%); z-index: 100; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: left 0.3s ease-out, top 0.3s ease-out; /* Smooth movement for timeline */
    }
    
    .token-icon {
      width: 100%; height: 100%; border-radius: var(--radius-md);
      background-size: cover; background-position: center;
      border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.8);
      z-index: 10; position: relative; font-family: 'Oswald';
    }
    
    /* Vision Cone */
    .vision-cone {
      position: absolute; top: 50%; left: 50%;
      width: 250px; height: 250px;
      background: linear-gradient(to right, transparent 35%, rgba(255, 255, 255, 0.15) 50%, transparent 65%);
      clip-path: polygon(50% 50%, 0% 0%, 100% 0%);
      transform-origin: 50% 50%;
      transform: translate(-50%, -50%) rotate(0deg);
      pointer-events: none; z-index: 1;
    }

    .token-label {
      position: absolute; top: 115%; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.9); color: var(--accent);
      font-size: 10px; white-space: nowrap; padding: 4px 8px;
      border-radius: var(--radius-full); margin-top: 4px; pointer-events: none;
      font-family: 'Roboto Mono', monospace; z-index: 20; border: 1px solid #333;
    }
    
    /* Weapon Badge */
    .wep-badge {
        position: absolute; bottom: -8px; right: -8px; 
        background: #000; color: white; font-size: 8px; padding: 2px 4px;
        border-radius: 4px; border: 1px solid #555; z-index: 25;
        font-family: 'Roboto Mono'; font-weight: bold;
        white-space: nowrap; max-width: 48px; overflow: hidden; text-overflow: ellipsis;
    }
    
    /* Spec Badge */
    .spec-badge {
        position: absolute; top: -10px; right: -10px;
        width: 24px; height: 24px; border-radius: 50%;
        background-color: #000; background-size: cover; background-position: center;
        border: 1px solid var(--accent); z-index: 26;
        box-shadow: 0 2px 5px black;
    }
    
    /* Timer Badge (Cashout) */
    .timer-badge {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85); color: var(--accent); 
        font-family: 'Roboto Mono'; font-weight: bold; font-size: 14px;
        padding: 4px 8px; border-radius: 4px; border: 1px solid var(--accent);
        z-index: 30; white-space: nowrap; pointer-events: none;
    }

    /* Player Specific Tokens */
    .player-token .token-icon { 
      border-radius: 50%; border-width: 3px; display: flex; 
      align-items: center; justify-content: center; font-weight: bold; 
      text-shadow: 0 1px 2px black; font-size: 1.2rem; 
    }
    .token-dead .token-icon { filter: grayscale(100%) brightness(0.6); border-color: #555 !important; }
    .token-dead .token-label { color: var(--danger); text-decoration: line-through; }
    .token-dead:after { 
        content: '☠️'; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); 
        font-size:1.8rem; z-index:30; text-shadow: 0 0 10px black;
    }

    /* --- RIGHT SIDEBAR --- */
    .match-team {
      background: #1a1a1a; margin-bottom: 15px; border-top: 3px solid #555;
      border-radius: 0 0 var(--radius-md) var(--radius-md); overflow: hidden;
    }
    .match-team-header {
      padding: 12px 15px; background: #111; display: flex; justify-content: space-between; align-items: center;
    }
    .team-name-input { 
      background: transparent; border: none; color: inherit; font-weight: bold; font-family: 'Oswald'; font-size: 1rem; width: 60%; padding: 0; margin: 0;
    }
    .team-score-input { 
      background: transparent; border: 1px solid transparent; color: var(--accent); 
      font-family: 'Roboto Mono'; font-weight: bold; font-size: 1rem; 
      width: 80px; padding: 2px 5px; text-align: right; border-radius: 4px;
    }
    .team-score-input:focus { border-color: #444; background: #222; outline: none; }
    
    .player-row {
      display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #2a2a2a;
      font-size: 0.85rem; cursor: grab; background: #1a1a1a;
      transition: background 0.2s;
    }
    .player-row:hover { background: #252525; }
    .player-row:active { cursor: grabbing; }

    .player-name-input {
      background: transparent; border: none; border-bottom: 1px solid transparent; color: inherit; font-weight: bold; 
      width: 100%; margin: 0 8px; padding: 2px;
    }
    .player-name-input:focus { border-bottom: 1px solid var(--accent); }

    .p-status {
      width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; cursor: pointer;
      border: 1px solid #555; background: #000; flex-shrink: 0;
    }
    .p-status.alive { background: var(--success); box-shadow: 0 0 6px var(--success); border-color: var(--success); }
    .p-status.dead { background: var(--danger); border-color: var(--danger); }
    
    .class-selector {
      width: 45px; margin: 0 5px 0 0; padding: 4px; font-size: 0.75rem; text-align: center; background: #000; border-radius: 4px;
    }
    
    .gear-btn {
        background: transparent; border: none; color: #666; width: auto; padding: 4px; margin: 0;
    }
    .gear-btn:hover { color: var(--accent); background: transparent; transform: rotate(90deg); }

    /* --- ECONOMY PANEL --- */
    .eco-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .eco-btn { font-size: 0.7rem; padding: 12px 4px; height: 100%; border-radius: var(--radius-md); }
    .eco-label { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-bottom: 6px; border-bottom: 1px solid #333; margin-top: 15px; padding-bottom: 2px; font-weight: bold; letter-spacing: 1px; }

    /* --- DATA TABLE --- */
    .data-table-container { overflow-x: auto; background: #111; border: 1px solid #333; border-radius: var(--radius-md); }
    .data-table { width: 100%; border-collapse: collapse; font-family: 'Roboto Mono'; font-size: 0.75rem; white-space: nowrap; }
    .data-table th { text-align: left; color: var(--accent); background: #080808; padding: 12px 10px; border-bottom: 2px solid #333; position: sticky; top: 0; font-size: 0.8rem; }
    .data-table td { border-bottom: 1px solid #222; padding: 10px; color: #ccc; }
    .data-table tr:hover { background: #1f1f1f; }
    .data-val { color: white; font-weight: bold; }
    
    .stat-bar { height: 4px; background: #333; margin-top: 4px; border-radius: 2px; overflow: hidden; }
    .stat-fill { height: 100%; background: var(--info); }

    /* --- CONTROLS --- */
    #rotation-control {
      position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%);
      background: rgba(18, 18, 18, 0.95); padding: 20px; border-radius: 20px;
      display: none; z-index: 200; border: 1px solid var(--accent);
      text-align: center; min-width: 280px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
    }
    input[type=range] { width: 100%; accent-color: var(--accent); margin-bottom: 8px; cursor: pointer;}
    
    .skull-btn {
        width: 40px; height: 40px; border-radius: 50%; padding: 8px;
        background: #2a0000; border: 1px solid var(--danger);
        cursor: pointer; transition: 0.2s; display:flex; align-items:center; justify-content:center;
    }
    .skull-btn:hover { background: var(--danger); transform: scale(1.1); }
    .skull-btn.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    .skull-btn img { width: 100%; height: 100%; object-fit: contain; filter: invert(1); }

    /* Timeline Controller */
    #timeline-panel {
      position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 650px;
      background: rgba(12, 12, 12, 0.9);
      backdrop-filter: blur(15px);
      border: 1px solid #333;
      border-radius: 24px;
      padding: 15px 20px;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 150;
      transition: opacity 0.3s;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: none; /* Hidden by default */
    }
    #timeline-panel.active { display: flex; }
    
    .timeline-row { display: flex; align-items: center; gap: 12px; justify-content: space-between; }
    .timeline-scrubber { flex: 1; height: 8px; appearance: none; background: #333; border-radius: 4px; outline: none; }
    .timeline-scrubber::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid black; box-shadow: 0 0 10px var(--accent); }
    .time-display { font-family: 'Roboto Mono'; color: var(--accent); font-weight: bold; font-size: 1.2rem; min-width: 60px; text-align: center; }

    /* --- MODALS & OVERLAYS --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.92); z-index: 9999; display: none;
      align-items: center; justify-content: center; flex-direction: column;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    
    .modal-box {
        background: var(--panel); border: 1px solid var(--panel-border);
        padding: 30px; width: 95%; max-width: 900px; position: relative;
        max-height: 90vh; overflow-y: auto; border-radius: 20px;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }
    
    .credits-footer {
        margin-top: 20px; font-size: 0.7rem; color: #555; text-align: center; border-top: 1px solid #222; padding-top: 15px;
    }
    .credits-footer a { color: #777; text-decoration: none; }
    .credits-footer a:hover { color: var(--accent); }

    #draw-layer { position: absolute; top:0; left:0; pointer-events: none; }

    .map-controls {
      position: absolute; bottom: 160px; right: 20px; 
      display:flex; flex-direction: column; gap:12px; 
    }
    .zoom-btn { 
        width: 44px; height: 44px; border-radius: 50%; padding:0; margin:0; 
        font-size: 1.2rem; background: rgba(18,18,18,0.9); border: 1px solid #444; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    }
    
    /* Match Timer Overlay */
    #match-timer-overlay {
        position: absolute; top: 20px; left: 20px;
        background: rgba(0,0,0,0.85); padding: 5px 10px; border-radius: 8px;
        border: 1px solid var(--accent); z-index: 100;
        display: flex; gap: 8px; align-items: center;
        backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: auto; height: auto;
        overflow: hidden; /* Ensure content is clipped */
    }
    /* Smart Minify */
    #match-timer-overlay.minimized {
        width: 60px; height: 60px; padding: 0; 
        justify-content: center; align-items: center;
        border-radius: 50%; border: 2px solid var(--accent);
        background: #000;
    }
    /* Explicitly hide controls and icon when minimized */
    #match-timer-overlay.minimized .timer-controls { display: none !important; }
    #match-timer-overlay.minimized i { display: none !important; }
    
    #match-timer-overlay.minimized #match-timer-val { 
        display: block; font-size: 1rem; color: var(--accent); margin: 0;
    }
    
    #match-timer-val { font-family: 'Roboto Mono'; font-size: 1.2rem; font-weight: bold; color: white; }
    
    /* RFI Leaderboard Styles */
    .rfi-card {
        background: #111; border: 1px solid #333; margin-bottom: 8px; padding: 12px;
        border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;
        transition: 0.2s; position: relative; overflow: hidden;
    }
    .rfi-card:hover { border-color: var(--accent); background: #161616; transform: translateX(2px); }
    .rfi-rank { font-size: 1.4rem; font-weight: bold; color: #fff; font-family: 'Oswald'; width: 35px; text-align: center; }
    .rfi-team { flex: 1; margin-left: 15px; }
    .rfi-name { font-weight: bold; color: white; display: block; font-size: 1rem; letter-spacing: 0.5px; }
    .rfi-players { font-size: 0.75rem; color: #888; font-family: 'Roboto Mono'; margin-top: 2px; }
    .rfi-score { font-family: 'Roboto Mono'; color: var(--accent); font-weight: bold; font-size: 1.1rem; text-align: right; margin-right: 15px; }
    .rfi-select-btn { margin-left: 10px; padding: 6px 12px; font-size: 0.7rem; width: auto; }
    
    /* Region Filter */
    .region-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #111; padding: 5px; border-radius: var(--radius-md); border: 1px solid #333; }
    .region-btn { 
        flex: 1; background: transparent; border: none; color: #666; 
        font-size: 0.75rem; font-weight: bold; padding: 8px; cursor: pointer; border-radius: 4px; 
        margin:0; text-align:center;
    }
    .region-btn.active { background: #333; color: white; }

    /* --- DATA TABLE MODAL SPECIFIC --- */
    .full-screen-data {
        width: 100%; height: 100%; position: fixed; top: 0; left: 0; 
        background: #050505; z-index: 5000; display: none; flex-direction: column;
        padding: 30px; overflow: hidden;
    }
    .full-screen-data.active { display: flex; }
    .data-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }

  </style>
</head>
<body>

<div id="app-container">
  
  <button id="toggle-left" class="mobile-toggle" onclick="toggleSidebar('left')"><i data-lucide="menu"></i></button>
  <button id="toggle-right" class="mobile-toggle" onclick="toggleSidebar('right')"><i data-lucide="bar-chart-2"></i></button>

  <!-- LEFT SIDEBAR -->
  <div id="sidebar-left" class="sidebar">
    <div class="brand-header">
      <div class="brand-row">
          <div style="display:flex; flex-direction:column;">
              <h1>Finals Strategy</h1>
              <span class="credits-sub">Created by Evoluti0N & Ireleezi</span>
          </div>
          <button class="auth-btn" onclick="showAuthModal()"><i data-lucide="user" width="14"></i> Login</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-btn active" onclick="setTab('tools')">
          <i data-lucide="map" width="16"></i> MAP
      </button>
      <button class="nav-btn" onclick="setTab('loadout')">
          <i data-lucide="layers" width="16"></i> STRAT
      </button>
      <button class="nav-btn" onclick="setTab('data')">
          <i data-lucide="database" width="16"></i> DATA
      </button>
      <button class="nav-btn" onclick="setTab('esports')">
          <i data-lucide="trophy" width="16"></i> ESPORT
      </button>
    </div>

    <!-- TAB: TOOLS -->
    <div id="tab-tools" class="content-pane active">
      <h3><i data-lucide="map"></i> Map Selection</h3>
      <select id="map-select" onchange="loadMap(this.value)"></select>

      <h3><i data-lucide="pen-tool"></i> Tactic Tools</h3>
      
      <!-- New Toolbar -->
      <div class="tactic-toolbar">
        <!-- Drawing Tools Group -->
        <div class="tool-group">
            <button id="btn-pen" class="toolbar-btn" onclick="setTool('pen')" title="Freehand Pen">
                <i data-lucide="pen-tool" width="18"></i>
            </button>
            <button id="btn-arrow" class="toolbar-btn" onclick="setTool('arrow')" title="Directional Arrow">
                <i data-lucide="move-up-right" width="18"></i>
            </button>
            <button id="btn-eraser" class="toolbar-btn" onclick="setTool('eraser')" title="Eraser">
                <i data-lucide="eraser" width="18"></i>
            </button>
        </div>

        <!-- Recorder Button -->
        <div class="rec-btn-wrapper">
            <button id="btn-rec-toggle" class="toolbar-rec-btn" onclick="toggleTimelinePanel()" title="Open Strategy Recorder">
                <i data-lucide="video" width="20"></i>
                <span class="rec-text">REC</span>
            </button>
        </div>
        
        <!-- Info/Help Button -->
        <button onclick="showHelpModal()" class="toolbar-btn" style="margin-left:5px; border-radius:50%; width:30px; height:30px; color:#aaa;" title="How to use">
            <i data-lucide="help-circle" width="16"></i>
        </button>

        <!-- Color Presets -->
        <div class="color-presets">
            <div id="col-white" class="color-btn active" style="background:#ffffff;" onclick="setPresetColor('#ffffff')" title="White"></div>
            <div id="col-red" class="color-btn" style="background:#d6333e;" onclick="setPresetColor('#d6333e')" title="Red"></div>
            <div id="col-blue" class="color-btn" style="background:#3498db;" onclick="setPresetColor('#3498db')" title="Blue"></div>
            <div id="col-black" class="color-btn" style="background:#000000;" onclick="setPresetColor('#000000')" title="Black"></div>
            <!-- Hidden Input for Logic -->
            <input type="color" id="draw-color" value="#ffffff" style="width:0; height:0; opacity:0; position:absolute;">
        </div>
      </div>

      <!-- Info Bar (Hidden by default) -->
      <div id="rec-info-bar" class="help-bar">
          <strong><i data-lucide="info" width="12" style="display:inline; margin-right:4px;"></i> STRAT RECORDER ACTIVE</strong>
          1. Position Tokens on Map.<br>
          2. Click <b>"ADD STEP"</b> in timeline below.<br>
          3. Move Tokens & Repeat. Press Play to animate.
      </div>

      <div style="display:flex; gap:8px;">
          <button onclick="clearDraw()" class="btn-danger" style="font-size:0.75rem;">Clear Ink</button>
          <button onclick="clearTokens()" class="btn-danger" style="font-size:0.75rem;">Clear Icons</button>
      </div>

      <h3>Objectives</h3>
      <div class="gadget-grid">
        <div class="draggable-item" draggable="true" data-type="obj" data-name="Cashout" data-src="cashout.png" style="background-image: url('cashout.png'); background-color:var(--primary); border-color: var(--primary);"></div>
        <div class="draggable-item" draggable="true" data-type="obj" data-name="Vault" data-src="vault.png" style="background-image: url('vault.png'); background-color:var(--accent); border-color: var(--accent);"></div>
      </div>

      <h3>Utility</h3>
      <div class="gadget-grid" id="gadget-palette"></div>

      <div class="credits-footer">
        Map images courtesy of <a href="https://www.thefinals.wiki/" target="_blank">TheFinals.wiki</a> & <a href="https://apesquad.org/" target="_blank">ApeSquad.org</a>. <br>
        Strat assets © Embark Studios.
      </div>
    </div>

    <!-- TAB: LOADOUT -->
    <div id="tab-loadout" class="content-pane">
      <button class="btn-accent" onclick="document.getElementById('video-overlay').classList.add('active')"><i data-lucide="film"></i> Theater Mode</button>
      <button class="btn-primary" onclick="generateShareLink()"><i data-lucide="share-2"></i> Share Strategy Link</button>
      
      <h3>Team Strategy</h3>
      <div style="background: #000; padding: 15px; border: 1px solid #333; margin-bottom: 15px; border-radius: var(--radius-md);">
        <label>Strategy Name</label>
        <input type="text" id="preset-name" placeholder="e.g., Kyoto - Temple Def">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn-primary" onclick="saveLoadoutPreset()">Save</button>
          <button onclick="loadPresetPrompt()">Load</button>
        </div>
      </div>

      <div id="loadout-editor"></div>
    </div>

    <!-- TAB: DATA BANK (Preview) -->
    <div id="tab-data" class="content-pane">
        <button class="btn-accent" onclick="openFullData()"><i data-lucide="maximize-2"></i> OPEN WEAPON DATA LAB</button>
        
        <h3>Meta Weapon TTK (Body)</h3>
        <div class="data-table-container">
            <table class="data-table">
                <thead><tr><th>Wep</th><th>Class</th><th>TTK (M)</th></tr></thead>
                <tbody>
                    <tr><td>V9S</td><td>L</td><td>0.8s</td></tr>
                    <tr><td>Lewis Gun</td><td>H</td><td>1.0s</td></tr>
                    <tr><td>CB-01 Repeater</td><td>M</td><td>1.5s (Burst)</td></tr>
                </tbody>
            </table>
        </div>

        <h3>Respawn Manager</h3>
        <div style="background:#1a1a1a; padding:15px; text-align:center; border: 1px solid #333; border-radius: var(--radius-md);">
            <div id="respawn-timer" style="font-size:2.5rem; font-family:'Roboto Mono'; color:var(--accent); margin-bottom:10px;">00:00</div>
            <div style="display:flex; gap:8px;">
                <button onclick="startTimer(22)" class="btn-tool">Coin (22s)</button>
                <button onclick="startTimer(45)" class="btn-tool">Wipe (45s)</button>
            </div>
            <button class="btn-danger" onclick="stopTimer()" style="margin-top:8px;">Stop</button>
        </div>
        
        <div class="credits-footer">
            Data sourced from <a href="https://apesquad.org/gundata" target="_blank">ApeSquad.org</a>.
        </div>
    </div>

    <!-- TAB: ESPORTS -->
    <div id="tab-esports" class="content-pane">
        <h3><i data-lucide="trophy"></i> RFI Leaderboard (TGM)</h3>
        
        <div class="region-tabs">
            <button class="region-btn active" onclick="filterLeaderboard('ALL')">ALL</button>
            <button class="region-btn" onclick="filterLeaderboard('EMEA')">EMEA</button>
            <button class="region-btn" onclick="filterLeaderboard('NA')">NA</button>
            <button class="region-btn" onclick="filterLeaderboard('APAC')">APAC</button>
        </div>
        
        <!-- Team Cards -->
        <div id="rfi-container">
            <!-- Team Secret -->
            <div class="rfi-card" data-region="EMEA" style="border-left: 4px solid #fff;">
                <div class="rfi-rank">1</div>
                <div class="rfi-team">
                    <span class="rfi-name">TEAM SECRET <span style="font-size:0.7rem; color:#666;">(EMEA)</span></span>
                    <div class="rfi-players">ELYX | OJI | ROMA</div>
                </div>
                <div class="rfi-score">150 RFI</div>
                <button class="btn-primary rfi-select-btn" onclick="importTeam('Team Secret', '#ffffff')">Select</button>
            </div>

            <!-- ENVY -->
            <div class="rfi-card" data-region="NA" style="border-left: 4px solid #0055ff;">
                <div class="rfi-rank">1</div>
                <div class="rfi-team">
                    <span class="rfi-name">ENVY <span style="font-size:0.7rem; color:#666;">(NA)</span></span>
                    <div class="rfi-players">UNI | GREMLIN | NOTBUBBA</div>
                </div>
                <div class="rfi-score">390 RFI</div>
                <button class="btn-primary rfi-select-btn" onclick="importTeam('Envy', '#0055ff')">Select</button>
            </div>

            <!-- FIVE FEARS -->
            <div class="rfi-card" data-region="EMEA" style="border-left: 4px solid #ff0000;">
                <div class="rfi-rank">2</div>
                <div class="rfi-team">
                    <span class="rfi-name">FIVE FEARS <span style="font-size:0.7rem; color:#666;">(EMEA)</span></span>
                    <div class="rfi-players">TREASON | CARNIFEX | NAGHOST</div>
                </div>
                <div class="rfi-score">40 RFI</div>
                <button class="btn-primary rfi-select-btn" onclick="importTeam('Five Fears', '#ff0000')">Select</button>
            </div>
            
            <!-- NTMR -->
            <div class="rfi-card" data-region="NA" style="border-left: 4px solid #800080;">
                <div class="rfi-rank">2</div>
                <div class="rfi-team">
                    <span class="rfi-name">NTMR <span style="font-size:0.7rem; color:#666;">(NA)</span></span>
                    <div class="rfi-players">LASAGNA | LAMP | GRAD</div>
                </div>
                <div class="rfi-score">150 RFI</div>
                <button class="btn-primary rfi-select-btn" onclick="importTeam('NTMR', '#800080')">Select</button>
            </div>
            
            <!-- APAC MOCK -->
            <div class="rfi-card" data-region="APAC" style="border-left: 4px solid #fcd116;">
                <div class="rfi-rank">1</div>
                <div class="rfi-team">
                    <span class="rfi-name">ZETA <span style="font-size:0.7rem; color:#666;">(APAC)</span></span>
                    <div class="rfi-players">PLAYER1 | PLAYER2 | PLAYER3</div>
                </div>
                <div class="rfi-score">220 RFI</div>
                <button class="btn-primary rfi-select-btn" onclick="importTeam('Zeta', '#fcd116')">Select</button>
            </div>
        </div>

        <div style="background:#111; padding:20px; border-radius:var(--radius-md); text-align:center; border:1px solid #333; margin-top:20px;">
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">View full live standings at ReachTheFinals.com</p>
            <a href="https://www.reachthefinals.com/tgm" target="_blank" style="text-decoration:none;">
                <button class="btn-primary" style="margin:0 auto; width:auto; padding:12px 24px; font-size:1rem;">
                    <i data-lucide="external-link"></i> OPEN TGM LEADERBOARD
                </button>
            </a>
        </div>
    </div>
  </div>

  <!-- CENTER STAGE -->
  <div id="main-stage">
    <div id="map-wrapper">
      <img id="map-img" src="" alt="Select Map">
      <svg id="line-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5;"></svg>
      <canvas id="draw-layer" style="z-index:6;"></canvas>
      <div id="icon-layer" style="z-index:10;"></div>
    </div>
    
    <!-- Global Match Timer -->
    <div id="match-timer-overlay" onclick="toggleTimerMinify(event)">
        <i data-lucide="clock" color="var(--accent)"></i>
        <div id="match-timer-val">10:00</div>
        <div class="timer-controls" style="display:flex; flex-direction:column; gap:2px;">
            <button onclick="toggleMatchTimer(); event.stopPropagation();" style="padding:2px 6px; font-size:0.6rem; width:auto; margin:0;" class="btn-primary">Start/Stop</button>
            <button onclick="resetMatchTimer(); event.stopPropagation();" style="padding:2px 6px; font-size:0.6rem; width:auto; margin:0; background:#333;">Reset</button>
        </div>
    </div>

    <!-- Timeline Controls (Hidden by Default) -->
    <div id="timeline-panel">
        <div class="timeline-row">
            <button onclick="addTimelineStep()" style="width:auto; padding:8px 16px; font-size:0.8rem; background:#333; border-radius:var(--radius-full);"><i data-lucide="plus-circle" width="14"></i> ADD STEP</button>
            <div class="time-display" id="match-time-display">00:00</div>
            <button id="play-btn" onclick="togglePlay()" style="width:auto; padding:8px 16px; font-size:0.8rem; border-radius:var(--radius-full);" class="btn-accent"><i data-lucide="play" width="14"></i></button>
            <button onclick="deleteTimelineStep()" style="width:auto; padding:8px; font-size:0.8rem; border-radius:50%; background:rgba(231, 76, 60, 0.2); color:var(--danger); border:1px solid var(--danger);"><i data-lucide="trash-2" width="14"></i></button>
            <button onclick="toggleTimelinePanel()" style="width:auto; padding:8px; font-size:0.8rem; background:transparent; color:#888; border:none; margin-left:auto;"><i data-lucide="x" width="14"></i></button>
        </div>
        <div class="timeline-row">
            <span style="font-size:0.7rem; color:#888;">START</span>
            <input type="range" id="timeline-scrubber" class="timeline-scrubber" min="0" max="0" value="0" step="1" oninput="scrubTimeline(this.value)">
            <span style="font-size:0.7rem; color:#888;">END</span>
        </div>
        <div style="text-align:center; font-size:0.7rem; color:#666;" id="step-info">Step 1: Setup</div>
    </div>

    <div id="rotation-control" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
      <div style="color:white; font-size:0.85rem; margin-bottom:15px; font-weight:bold; border-bottom:1px solid #333; padding-bottom:10px;">TOKEN ACTIONS</div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <label style="margin:0;">View Angle</label>
        <button id="skull-control" class="skull-btn" onclick="toggleTokenDeath()" title="Kill/Revive">
            <img src="https://cdn-icons-png.flaticon.com/512/155/155266.png" alt="Kill">
        </button>
      </div>

      <input type="range" id="vision-slider" min="0" max="360" value="0" oninput="rotateVision(this.value)">
      
      <!-- Size Slider -->
      <label style="margin-top:10px;">Size</label>
      <input type="range" id="size-slider" min="0.5" max="2" step="0.1" value="1" oninput="resizeToken(this.value)">
      
      <!-- Cashout Specific Control -->
      <div id="cashout-controls" style="display:none; border-top:1px solid #333; padding-top:10px; margin-top:10px;">
          <button class="btn-primary" onclick="startTokenTimer(130)" style="font-size:0.75rem;">Start Cashout (130s)</button>
          <button onclick="stopTokenTimer()" style="font-size:0.75rem; background:#333;">Reset Timer</button>
      </div>
      
      <!-- Zipline Specific Control -->
      <div id="zipline-controls" style="display:none; border-top:1px solid #333; padding-top:10px; margin-top:10px;">
          <button class="btn-accent" onclick="deployZipline()" style="font-size:0.75rem;">Deploy Line</button>
          <div style="font-size:0.6rem; color:#888; margin-top:5px;">Click map to set end point</div>
      </div>
      
      <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn-danger" onclick="deleteActiveToken()">Delete</button>
          <button onclick="closeRotationControl()" style="background:#333; color:#ccc;">Close</button>
      </div>
    </div>
    
    <div class="map-controls">
      <button class="zoom-btn" onclick="zoom(1.1)">+</button>
      <button class="zoom-btn" onclick="zoom(0.9)">-</button>
      <button class="zoom-btn" onclick="resetView()" style="font-size:0.8rem;">R</button>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div id="sidebar-right" class="sidebar">
    <!-- Right Sidebar Tabs -->
    <div class="nav-tabs" style="padding:0; border-bottom:none;">
        <button id="tab-btn-score" class="nav-btn active" onclick="setRightTab('score')" style="font-size:0.7rem;">SCOREBOARD</button>
        <button id="tab-btn-eco" class="nav-btn" onclick="setRightTab('eco')" style="font-size:0.7rem;">ECONOMY</button>
    </div>

    <!-- Right Sidebar Content -->
    <div id="right-tab-score" style="display:block; flex:1; overflow-y:auto; padding-bottom:20px;">
        <div style="padding:15px 15px 0 15px; border-bottom:1px solid #333;">
          <label>Game Mode</label>
          <select id="game-mode-select" onchange="renderMatchState()">
            <option value="cashout">Cashout (3v3v3v3)</option>
            <option value="final">Final Round (3v3)</option>
          </select>
        </div>
        <div id="scoreboard-container" style="padding:0;"></div>
    </div>

    <div id="right-tab-eco" style="display:none; flex:1; overflow-y:auto;">
        <div id="economy-panel" style="padding:20px; background:#0f0f0f;">
          <h3 style="margin:0 0 10px 0;">Economy Control</h3>
          
          <div class="eco-label">Actions</div>
          <div class="eco-grid">
            <button class="eco-btn" onclick="ecoEvent('kill')">Kill (+$500)</button>
            <button class="eco-btn" onclick="ecoEvent('open_vault')">Open ($1k)</button>
            <button class="eco-btn" onclick="ecoEvent('steal')">Steal ($1k)</button>
            <button class="eco-btn" onclick="ecoEvent('revive')">Revive</button>
          </div>

          <div class="eco-label">Deposits</div>
          <div class="eco-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="eco-btn btn-primary" onclick="ecoEvent('dep_1')">V 1/2<br>($2k)</button>
            <button class="eco-btn btn-primary" onclick="ecoEvent('dep_2')">V 3/4<br>($3k)</button>
            <button class="eco-btn btn-primary" onclick="ecoEvent('dep_3')">V 5/6<br>($4k)</button>
          </div>

          <div class="eco-label">Cashout</div>
          <div class="eco-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="eco-btn btn-accent" onclick="ecoEvent('fin_1')">$10k</button>
            <button class="eco-btn btn-accent" onclick="ecoEvent('fin_2')">$15k</button>
            <button class="eco-btn btn-accent" onclick="ecoEvent('fin_3')">$22k</button>
          </div>
          
          <div id="wipe-control" style="margin-top:15px;">
              <button class="eco-btn btn-danger" onclick="ecoEvent('wipe')" style="font-size:0.8rem; border:1px dashed var(--danger);">☠️ TEAM WIPE (-15%)</button>
          </div>
          <div style="margin-top:20px; font-size:0.7rem; color:#666; text-align:center;">
              Select Team Header in Scoreboard to apply.
          </div>
        </div>
    </div>
  </div>

</div>

<!-- FULL SCREEN DATA MODAL -->
<div id="full-data-modal" class="full-screen-data">
    <div class="data-header">
        <h1><i data-lucide="database"></i> WEAPON DATA LAB</h1>
        <button onclick="closeFullData()" style="width:auto; padding:10px 20px;" class="btn-danger">CLOSE X</button>
    </div>
    <div style="flex:1; overflow-y:auto;">
        <div id="weapon-data-content"></div>
    </div>
    <div class="credits-footer" style="margin-top:20px;">
        Values based on Season 4 Meta. Verified data from <a href="https://apesquad.org/gundata" target="_blank">ApeSquad.org</a>.
    </div>
</div>

<!-- LOADOUT EDIT MODAL (FOR ENEMIES) -->
<div id="loadout-modal" class="modal-overlay">
    <div class="modal-box" style="max-width:350px;">
        <h3 style="margin-top:0;">Edit Loadout</h3>
        <label id="loadout-modal-title">Player Name</label>
        
        <label>Specialization</label>
        <select id="modal-spec-select"></select>
        
        <label>Weapon</label>
        <select id="modal-wep-select"></select>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-primary" onclick="applyModalLoadout()">Apply</button>
            <button onclick="document.getElementById('loadout-modal').classList.remove('active')" style="background:transparent; border:none; color:#666;">Cancel</button>
        </div>
    </div>
</div>

<!-- HELP MODAL -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-box" style="max-width:500px;">
        <h2 style="color:var(--accent); margin-top:0;">COACHING TIPS & HELP</h2>
        
        <h4 style="color:white; border-bottom:1px solid #333; padding-bottom:5px;">Using the Tools</h4>
        <p style="font-size:0.85rem; color:#ccc;">
            - <b>Recorder</b>: Place tokens, click "ADD STEP", move tokens, repeat. Use Play to review rotations.<br>
            - <b>Enemies</b>: Click the Gear Icon on the Scoreboard to set their loadout. It appears on the map.<br>
            - <b>Ziplines</b>: Place a zipline, click it, then use "Deploy Line" to draw its path.<br>
            - <b>Match Timer</b>: Click the top-left timer icon to maximize/minimize it.
        </p>

        <h4 style="color:white; border-bottom:1px solid #333; padding-bottom:5px;">Economy Guide</h4>
        <p style="font-size:0.85rem; color:#ccc;">
            - <b>Vault</b>: Opening = $1,000. Stealing Cashout = $1,000.<br>
            - <b>Deposits</b>: Starting a cashout grants money based on value (e.g., $2k for 1st Vault).<br>
            - <b>Finish</b>: Completing a cashout grants the bulk sum (e.g., $10k).<br>
            - <b>Wipe</b>: Team wipe removes 30% (or customized 15%) of current cash.
        </p>
        
        <h4 style="color:white; border-bottom:1px solid #333; padding-bottom:5px;">Enemy Intel</h4>
        <p style="font-size:0.85rem; color:#ccc;">
            Use the "Gear" icon in the right sidebar next to enemy names to assign them weapons and specializations (e.g., Heal Beam, RPG). These icons will appear above their tokens on the map for quick identification during strat sessions.
        </p>

        <button onclick="document.getElementById('help-modal').classList.remove('active')" class="btn-primary" style="margin-top:20px;">Got it</button>
    </div>
</div>

<!-- VIDEO OVERLAY -->
<div id="video-overlay" class="modal-overlay">
  <div class="modal-box" style="width:80%; height:80%;">
      <div class="video-toolbar" style="display:flex; gap:10px; margin-bottom:10px;">
        <input type="text" id="video-url" placeholder="Paste YouTube Embed URL" style="margin:0; flex:1;">
        <button onclick="loadVideo()" style="width:auto; margin:0;" class="btn-primary">Load</button>
        <button onclick="document.getElementById('video-overlay').classList.remove('active')" style="width:auto; margin:0; border-color:var(--danger); color:var(--danger);">Close</button>
      </div>
      <iframe id="video-frame" src="" style="width:100%; height:100%; border:none; border-radius:12px;" allowfullscreen></iframe>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="auth-modal" class="modal-overlay">
    <div class="modal-box" style="max-width:400px; text-align:center;">
        <h2 style="color:var(--accent); margin-top:0;">COACH LOGIN</h2>
        <p style="font-size:0.8rem; color:#888;">Sign in to sync your strats across devices.</p>
        <input type="email" placeholder="Email Address">
        <input type="password" placeholder="Password">
        <button class="btn-primary" onclick="handleAuth()" style="margin-top:10px;">Login / Register</button>
        <button onclick="document.getElementById('auth-modal').classList.remove('active')" style="background:transparent; border:none; color:#666; width:100%;">Cancel</button>
        <div style="margin-top:15px; font-size:0.7rem; color:#555;">
            * Simulation Mode Active
        </div>
    </div>
</div>

<script>
  // --- INITIALIZE ICONS ---
  lucide.createIcons();

  // --- DATA ---
  const mapData = {
    "Kyoto (Wiki)": "Kyoto.png",
    "Seoul (Wiki)": "Seoul.png",
    "Monaco (Wiki)": "Monaco.png",
    "Skyway Stadium (Wiki)": "Skyway Stadium.png",
    "SysHorizon (Wiki)": "SysHorizon.png",
    "Fortune Stadium (Wiki)": "Fortune Stadium.png",
    "Bernal (Wiki)": "Bernal.png",
    "Fangwai City (ApeSquad)": "https://apesquad.org/images/maps/Fangwai.png",
    "Las Vegas (ApeSquad)": "https://apesquad.org/images/maps/Vegas.png"
  };

  const gadgetDB = [
    { name: "Dome Shield", url: "https://www.thefinals.wiki/w/images/thumb/c/cd/Dome_Shield_Rank_1.png/100px-Dome_Shield_Rank_1.png.webp" },
    { name: "RPG-7", url: "https://www.thefinals.wiki/w/images/thumb/7/7a/RPG-7_Rank_1.png/100px-RPG-7_Rank_1.png.webp" },
    { name: "Zipline", url: "https://www.thefinals.wiki/w/images/thumb/4/49/Zipline_Rank_1.png/100px-Zipline_Rank_1.png.webp" },
    { name: "Jump Pad", url: "https://www.thefinals.wiki/w/images/thumb/e/ef/Jump_Pad_Rank_1.png/100px-Jump_Pad_Rank_1.png.webp" },
    { name: "Glitch Grenade", url: "https://www.thefinals.wiki/w/images/thumb/b/b5/Glitch_Grenade_Rank_1.png/100px-Glitch_Grenade_Rank_1.png.webp" },
    { name: "Gateway", url: "https://www.thefinals.wiki/w/images/thumb/c/c4/Gateway_Rank_1.png/100px-Gateway_Rank_1.png.webp" },
    { name: "Goo Grenade", url: "https://www.thefinals.wiki/w/images/thumb/9/93/Goo_Grenade_Rank_1.png/100px-Goo_Grenade_Rank_1.png.webp" }
  ];
  
  // Spec Image Mapping
  const specIcons = {
      "Cloaking Device": "https://www.thefinals.wiki/w/images/thumb/b/b0/Cloaking_Device_Rank_1.png/100px-Cloaking_Device_Rank_1.png.webp",
      "Evasive Dash": "https://www.thefinals.wiki/w/images/thumb/4/42/Evasive_Dash_Rank_1.png/100px-Evasive_Dash_Rank_1.png.webp",
      "Grappling Hook": "https://www.thefinals.wiki/w/images/thumb/b/b4/Grappling_Hook_Rank_1.png/100px-Grappling_Hook_Rank_1.png.webp",
      "Dematerializer": "https://www.thefinals.wiki/w/images/thumb/0/0d/Dematerializer_Rank_1.png/100px-Dematerializer_Rank_1.png.webp",
      "Healing Beam": "https://www.thefinals.wiki/w/images/thumb/b/b5/Healing_Beam_Card.png/100px-Healing_Beam_Card.png.webp",
      "Guardian Turret": "https://www.thefinals.wiki/w/images/thumb/a/a7/Guardian_Turret_Card.png/100px-Guardian_Turret_Card.png.webp",
      "Charge 'N' Slam": "https://www.thefinals.wiki/w/images/thumb/4/45/Charge_N_Slam_Rank_1.png/100px-Charge_N_Slam_Rank_1.png.webp",
      "Goo Gun": "https://www.thefinals.wiki/w/images/thumb/2/2d/Goo_Gun_Card.png/100px-Goo_Gun_Card.png.webp",
      "Mesh Shield": "https://www.thefinals.wiki/w/images/thumb/e/e9/Mesh_Shield_Rank_1.png/100px-Mesh_Shield_Rank_1.png.webp",
      "Winch Claw": "https://www.thefinals.wiki/w/images/thumb/e/e0/Winch_Claw_Rank_1.png/100px-Winch_Claw_Rank_1.png.webp"
  };

  const classData = {
    Light: {
      specs: ["Grappling Hook", "Evasive Dash", "Cloaking Device"],
      weapons: ["M11", "XP-54", "V9S", "LH1", "SR-84", "Sword", "Throwing Knives", "SH1900", "Dagger", "93R"],
      gadgets: ["Glitch Grenade", "Stun Gun", "Vanishing Bomb", "Gateway", "Thermal Bore", "Breach Charge"]
    },
    Medium: {
      specs: ["Healing Beam", "Guardian Turret", "Dematerializer"],
      weapons: ["AKM", "FCAR", "Model 1887", "CL-40", "R.357", "FAMAS", "Dual Blades", "Pike-556"],
      gadgets: ["Defibrillator", "Jump Pad", "Zipline", "APS Turret", "Glitch Trap", "Explosive Mine"]
    },
    Heavy: {
      specs: ["Mesh Shield", "Charge 'N' Slam", "Goo Gun", "Winch Claw"],
      weapons: ["Lewis Gun", "M60", "SA1216", "Sledgehammer", "Flamethrower", "Spear", "KS-23", "MGL32"],
      gadgets: ["RPG-7", "Dome Shield", "Barricade", "C4", "Anti-Gravity Cube", "Pyro Grenade"]
    }
  };

  // Expanded Weapon Data for the modal
  const weaponStats = [
      // LIGHT
      { name: "XP-54", class: "Light", dmg: 18, rpm: 900, mag: 30, hs: 1.5, ttkM: 0.85, reload: 2.1 },
      { name: "M11", class: "Light", dmg: 16, rpm: 1100, mag: 40, hs: 1.5, ttkM: 0.8, reload: 1.7 },
      { name: "V9S", class: "Light", dmg: 36, rpm: 450, mag: 20, hs: 1.5, ttkM: 0.8, reload: 1.3 },
      { name: "LH1", class: "Light", dmg: 47, rpm: 300, mag: 15, hs: 2.0, ttkM: 0.8, reload: 2.4 },
      { name: "SH1900", class: "Light", dmg: 180, rpm: 100, mag: 2, hs: 1.0, ttkM: 0.0, reload: 2.8 },
      { name: "SR-84", class: "Light", dmg: 115, rpm: 50, mag: 6, hs: 2.0, ttkM: 1.2, reload: 3.3 },
      { name: "Throwing Knives", class: "Light", dmg: 60, rpm: 110, mag: "Inf", hs: 1.5, ttkM: 1.1, reload: 0 },
      { name: "Sword", class: "Light", dmg: 74, rpm: "N/A", mag: "Inf", hs: 1.0, ttkM: "N/A", reload: 0 },
      // MEDIUM
      { name: "AKM", class: "Medium", dmg: 20, rpm: 600, mag: 36, hs: 1.5, ttkM: 0.95, reload: 2.1 },
      { name: "FCAR", class: "Medium", dmg: 22, rpm: 540, mag: 25, hs: 1.5, ttkM: 0.9, reload: 2.0 },
      { name: "FAMAS", class: "Medium", dmg: 24, rpm: 650, mag: 27, hs: 1.5, ttkM: 0.9, reload: 2.3 },
      { name: "CB-01 Repeater", class: "Medium", dmg: 128, rpm: 80, mag: 6, hs: 1.0, ttkM: 1.5, reload: 3.5 },
      { name: "CL-40", class: "Medium", dmg: 84, rpm: 140, mag: 4, hs: 1.0, ttkM: 1.7, reload: 2.9 },
      { name: "R.357", class: "Medium", dmg: 74, rpm: 150, mag: 6, hs: 2.0, ttkM: 0.8, reload: 2.5 },
      { name: "Dual Blades", class: "Medium", dmg: 50, rpm: "N/A", mag: "Inf", hs: 1.0, ttkM: "N/A", reload: 0 },
      { name: "Pike-556", class: "Medium", dmg: 42, rpm: 350, mag: 12, hs: 1.8, ttkM: 0.9, reload: 2.2 },
      // HEAVY
      { name: "Lewis Gun", class: "Heavy", dmg: 25, rpm: 600, mag: 47, hs: 1.5, ttkM: 1.0, reload: 3.2 },
      { name: "M60", class: "Heavy", dmg: 19, rpm: 580, mag: 70, hs: 1.5, ttkM: 1.1, reload: 3.9 },
      { name: "SA1216", class: "Heavy", dmg: 70, rpm: 250, mag: 16, hs: 1.0, ttkM: 0.7, reload: 3.5 },
      { name: "KS-23", class: "Heavy", dmg: 100, rpm: 70, mag: 6, hs: 1.0, ttkM: 1.7, reload: 3.8 },
      { name: "Sledgehammer", class: "Heavy", dmg: 115, rpm: "N/A", mag: "Inf", hs: 1.0, ttkM: "N/A", reload: 0 },
      { name: "Flamethrower", class: "Heavy", dmg: 30, rpm: "Cont", mag: 40, hs: 1.0, ttkM: 1.2, reload: 3.0 },
      { name: "Spear", class: "Heavy", dmg: 80, rpm: "N/A", mag: "Inf", hs: 1.0, ttkM: "N/A", reload: 0 }
  ];

  const defaultTeams = [
    { name: "Vogues (My Team)", color: "#FF69B4", cash: 0, players: [ {c:'L', n:'Player 1'}, {c:'M', n:'Player 2'}, {c:'H', n:'Player 3'} ] },
    { name: "Steamers (Orange)", color: "#FFA500", cash: 0, players: [ {c:'H', n:'Enemy 1'}, {c:'H', n:'Enemy 2'}, {c:'M', n:'Enemy 3'} ] },
    { name: "Socialites (Purple)", color: "#9370DB", cash: 0, players: [ {c:'M', n:'Enemy 1'}, {c:'M', n:'Enemy 2'}, {c:'M', n:'Enemy 3'} ] },
    { name: "Kingfish (Blue)", color: "#00BFFF", cash: 0, players: [ {c:'L', n:'Enemy 1'}, {c:'L', n:'Enemy 2'}, {c:'H', n:'Enemy 3'} ] }
  ];

  let teams = JSON.parse(JSON.stringify(defaultTeams));

  // Global State
  let scale = 0.5, pX = 0, pY = 0;
  let currentTool = null, isDragging = false, startX, startY, ctx;
  let currentDrawColor = '#ffffff'; // Default to white
  let selectedTeamIdx = 0;
  let activeTokenId = null; 
  let timerInterval = null;
  let editingPlayerRef = null; // {tIdx, pIdx}
  
  // Timer States
  let matchTimer = 600; // 10 mins
  let matchTimerInterval = null;
  let activeCashoutInterval = null;
  
  // Timeline State
  let timelineSteps = []; // Array of snapshot objects
  let currentStepIndex = 0;
  let isPlaying = false;
  let playInterval = null;
  let matchTime = 0; // in seconds
  
  // Drawing State for Zipline
  let ziplineDeployMode = false;

  // --- INITIALIZATION ---
  function init() {
    // 1. Populate Maps
    const ms = document.getElementById('map-select');
    for(let m in mapData) { let opt = document.createElement('option'); opt.value = mapData[m]; opt.text = m; ms.appendChild(opt); }
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedData = urlParams.get('data');
    if(sharedData) {
        loadSharedState(sharedData);
    } else {
        if(ms.options.length > 0) loadMap(ms.options[0].value);
    }

    // 2. Populate Gadgets
    const gp = document.getElementById('gadget-palette');
    gadgetDB.forEach(g => {
      const div = document.createElement('div');
      div.className = 'draggable-item';
      div.style.backgroundImage = `url('${g.url}')`;
      div.draggable = true;
      div.title = g.name;
      div.dataset.type = 'gadget';
      div.dataset.name = g.name;
      div.dataset.src = g.url;
      addTouchDragSupport(div);
      gp.appendChild(div);
    });

    // 3. Populate Weapon Data
    renderWeaponData();

    renderLoadoutEditor();
    renderMatchState();
    setupInteractions();
    setupMobileInteractions();
    
    // Auth Check
    const user = localStorage.getItem('tf_user');
    if(user) document.querySelector('.auth-btn').innerHTML = `<i data-lucide="check"></i> ${JSON.parse(user).email.split('@')[0]}`;
    
    // Initialize Timeline
    addTimelineStep(); // Create Step 0 (Start)
  }

  // --- RESPONSIVE SIDEBARS ---
  function toggleSidebar(side) {
    const el = document.getElementById('sidebar-' + side);
    el.classList.toggle('open');
  }
  
  function setupMobileInteractions() {
     document.getElementById('main-stage').addEventListener('click', () => {
         if(window.innerWidth <= 1024) {
             document.getElementById('sidebar-left').classList.remove('open');
             document.getElementById('sidebar-right').classList.remove('open');
         }
     });
  }

  // --- RENDERERS ---

  function renderLoadoutEditor() {
    const container = document.getElementById('loadout-editor');
    container.innerHTML = '';
    
    const t = teams[0];
    t.players.forEach((p, pIdx) => {
      if(!p.loadout) p.loadout = { spec: '', wep: '', g1: '', g2: '', g3: '' };
      const cData = classData[p.c === 'L' ? 'Light' : p.c === 'M' ? 'Medium' : 'Heavy'];

      const slot = document.createElement('div');
      slot.style.background = "#0e0e0e";
      slot.style.padding = "10px";
      slot.style.borderLeft = `3px solid ${t.color}`;
      slot.style.marginBottom = "10px";
      slot.style.borderRadius = "8px";
      
      slot.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
           <span style="font-weight:bold; color:${t.color}; font-size:0.85rem;">P${pIdx+1} (${p.c})</span>
           <span style="font-size:0.75rem; color:#888;">${p.n}</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:5px;">
          <div><select onchange="updateLoadout(${pIdx},'spec',this.value)">${createOptions(cData.specs, p.loadout.spec)}</select></div>
          <div><select onchange="updateLoadout(${pIdx},'wep',this.value)">${createOptions(cData.weapons, p.loadout.wep)}</select></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
           <select onchange="updateLoadout(${pIdx},'g1',this.value)">${createOptions(cData.gadgets, p.loadout.g1)}</select>
           <select onchange="updateLoadout(${pIdx},'g2',this.value)">${createOptions(cData.gadgets, p.loadout.g2)}</select>
           <select onchange="updateLoadout(${pIdx},'g3',this.value)">${createOptions(cData.gadgets, p.loadout.g3)}</select>
        </div>
      `;
      container.appendChild(slot);
    });
  }

  function createOptions(arr, current) {
    return `<option value="">-</option>` + arr.map(item => `<option value="${item}" ${item===current?'selected':''}>${item}</option>`).join('');
  }

  function setRightTab(tab) {
      document.querySelectorAll('#sidebar-right .nav-btn').forEach(b => b.classList.remove('active'));
      // Find button corresponding to tab
      const btn = document.getElementById('tab-btn-' + tab);
      if(btn) btn.classList.add('active');
      
      if(tab === 'score') {
          document.getElementById('right-tab-score').style.display = 'block';
          document.getElementById('right-tab-eco').style.display = 'none';
      } else {
          document.getElementById('right-tab-score').style.display = 'none';
          document.getElementById('right-tab-eco').style.display = 'block';
      }
  }

  function renderMatchState() {
    const container = document.getElementById('scoreboard-container');
    container.innerHTML = '';
    const mode = document.getElementById('game-mode-select').value;
    const limit = mode === 'cashout' ? 4 : 2;

    const ecoPanel = document.getElementById('economy-panel');
    const wipeCtrl = document.getElementById('wipe-control');
    const ecoTabBtn = document.getElementById('tab-btn-eco');
    
    if (mode === 'final') {
        wipeCtrl.style.display = 'none';
        ecoTabBtn.style.display = 'none'; // Hide Economy Tab Button
        if (ecoTabBtn.classList.contains('active')) {
            setRightTab('score'); // Force switch to scoreboard
        }
    } else {
        wipeCtrl.style.display = 'block';
        ecoTabBtn.style.display = 'block';
    }
    
    for(let i=0; i<limit; i++) {
      const t = teams[i];
      const div = document.createElement('div');
      div.className = 'match-team';
      div.style.borderTopColor = t.color;
      
      // Focus visual for final round
      if (mode === 'final') {
          div.style.marginBottom = '20px';
          div.style.borderWidth = '2px';
      }
      
      if(selectedTeamIdx === i) div.style.boxShadow = `0 0 15px ${t.color}30`;

      let html = `
        <div class="match-team-header" onclick="selectTeam(${i})" style="cursor:pointer; ${selectedTeamIdx===i ? 'background:#252525;' : ''}">
          <input class="team-name-input" style="color:${t.color};" value="${t.name}" onchange="updateTeamName(${i}, this.value)" onclick="event.stopPropagation()">
          <div style="display:flex; align-items:center; gap:5px;">
            <span style="font-family:'Roboto Mono'; font-weight:bold; color:var(--accent);">$</span>
            <input type="text" class="team-score-input" value="${t.cash.toLocaleString()}" onchange="updateTeamCash(${i}, this.value)" onclick="event.stopPropagation()">
          </div>
        </div>
      `;

      t.players.forEach((p, pIdx) => {
        const statusClass = (p.status === 'dead') ? 'dead' : 'alive';
        const lSel = p.c === 'L' ? 'selected' : '';
        const mSel = p.c === 'M' ? 'selected' : '';
        const hSel = p.c === 'H' ? 'selected' : '';

        // Add Gear Icon for loading out
        html += `
          <div class="player-row" draggable="true" 
               data-type="player" data-tidx="${i}" data-pidx="${pIdx}" 
               ondragstart="handleDragStart(event)">
            
            <div class="p-status ${statusClass}" onclick="toggleStatus(${i}, ${pIdx})"></div>
            
            <select class="class-selector" onchange="changeClass(${i}, ${pIdx}, this.value)" onclick="event.stopPropagation()">
                <option value="L" ${lSel}>L</option>
                <option value="M" ${mSel}>M</option>
                <option value="H" ${hSel}>H</option>
            </select>

            <input class="player-name-input" style="color:${t.color};" value="${p.n}" onchange="updatePlayerName(${i}, ${pIdx}, this.value)" onclick="event.stopPropagation()">
            
            <button class="gear-btn" onclick="openLoadoutModal(${i}, ${pIdx})" title="Edit Loadout">
                <i data-lucide="settings-2" width="14"></i>
            </button>
          </div>
        `;
      });
      div.innerHTML = html;
      container.appendChild(div);
    }
    
    document.querySelectorAll('.player-row').forEach(row => addTouchDragSupport(row));
    lucide.createIcons();
  }

  function renderWeaponData() {
      const container = document.getElementById('weapon-data-content');
      let html = `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:25px;">`;
      
      // Group by class
      ['Light', 'Medium', 'Heavy'].forEach(c => {
          html += `<div style="background:#111; border:1px solid #333; padding:20px; border-radius:16px;">
              <h2 style="color:var(--accent); border-bottom:1px solid #444; padding-bottom:10px; font-size:1.1rem; margin-top:0;">${c} Weapons</h2>
              <table class="data-table">
                  <thead><tr><th>Name</th><th>DMG</th><th>RPM</th><th>DPS</th><th>Mag</th><th>TTK(M)</th></tr></thead>
                  <tbody>`;
          
          weaponStats.filter(w => w.class === c).forEach(w => {
              // Calculate DPS
              let dps = "N/A";
              if (typeof w.rpm === 'number' && typeof w.dmg === 'number') {
                  dps = Math.round((w.dmg * w.rpm) / 60);
              }

              html += `<tr>
                  <td>${w.name}</td>
                  <td>${w.dmg}</td>
                  <td>${w.rpm}</td>
                  <td style="color:#aaa;">${dps}</td>
                  <td>${w.mag}</td>
                  <td style="color:${w.ttkM < 0.9 ? 'var(--success)' : '#ccc'}">${w.ttkM}s</td>
              </tr>`;
          });
          html += `</tbody></table></div>`;
      });
      html += `</div>`;
      container.innerHTML = html;
  }

  // --- LOGIC ---
  function updateTeamName(i, val) { teams[i].name = val; }
  function updatePlayerName(tIdx, pIdx, val) { 
    teams[tIdx].players[pIdx].n = val; 
    if(tIdx === 0) renderLoadoutEditor();
  }
  
  function updateTeamCash(i, val) {
      // Remove commas and convert to int
      let num = parseInt(val.replace(/,/g, ''));
      if(isNaN(num)) num = 0;
      teams[i].cash = num;
      renderMatchState();
  }
  
  function updateLoadout(pIdx, field, val) { 
    // Update data for Team 0 (My Team)
    if(!teams[0].players[pIdx].loadout) teams[0].players[pIdx].loadout = {};
    teams[0].players[pIdx].loadout[field] = val; 
    
    // Refresh Tokens
    updateTokenVisuals(0, pIdx);
  }

  // Generic Loadout Update for any team via Modal
  function updateAnyLoadout(tIdx, pIdx, spec, wep) {
      if(!teams[tIdx].players[pIdx].loadout) teams[tIdx].players[pIdx].loadout = {};
      teams[tIdx].players[pIdx].loadout.spec = spec;
      teams[tIdx].players[pIdx].loadout.wep = wep;
      
      if(tIdx === 0) renderLoadoutEditor(); // Sync if it was team 0
      updateTokenVisuals(tIdx, pIdx);
  }
  
  function importTeam(name, color) {
      let targetIdx = selectedTeamIdx;
      if (targetIdx === null) targetIdx = 1; 
      
      teams[targetIdx].name = name;
      teams[targetIdx].color = color;
      
      alert(`Imported ${name} to Slot ${targetIdx + 1}`);
      renderMatchState();
  }
  
  // Filter RFI Leaderboard
  function filterLeaderboard(region) {
      const cards = document.querySelectorAll('.rfi-card');
      document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      cards.forEach(card => {
          if (region === 'ALL' || card.dataset.region === region) {
              card.style.display = 'flex';
          } else {
              card.style.display = 'none';
          }
      });
  }

  function changeClass(tIdx, pIdx, newClass) {
    teams[tIdx].players[pIdx].c = newClass;
    if(tIdx === 0) renderLoadoutEditor();
    const tokens = document.querySelectorAll(`.placed-token[data-ref="${tIdx}-${pIdx}"] .token-icon`);
    tokens.forEach(el => el.innerText = newClass);
  }

  function selectTeam(i) { selectedTeamIdx = i; renderMatchState(); }
  
  function toggleStatus(t, p) {
    const player = teams[t].players[p];
    player.status = player.status === 'dead' ? 'alive' : 'dead';
    renderMatchState();
    updateMapTokenVisuals(t, p);
  }

  function toggleTokenDeath() {
      if(!activeTokenId) return;
      const el = document.getElementById(activeTokenId);
      
      // Safety check: Only player tokens can die
      if(el.classList.contains('player-token')) {
          const ref = el.dataset.ref.split('-');
          toggleStatus(parseInt(ref[0]), parseInt(ref[1]));
      }
      // Objective tokens do nothing
  }

  function ecoEvent(type) {
    if(selectedTeamIdx === null) return;
    const t = teams[selectedTeamIdx];
    
    if(type === 'kill') t.cash += 500;
    if(type === 'open_vault') t.cash += 1000;
    if(type === 'steal') t.cash += 1000;
    if(type === 'dep_1') t.cash += 2000; 
    if(type === 'dep_2') t.cash += 3000; 
    if(type === 'dep_3') t.cash += 4400; 
    if(type === 'fin_1') t.cash += 10000; 
    if(type === 'fin_2') t.cash += 15000; 
    if(type === 'fin_3') t.cash += 22000; 
    
    if(type === 'wipe') {
        const penalty = Math.floor(t.cash * 0.15);
        t.cash -= penalty;
        if(t.cash < 0) t.cash = 0;
    }

    renderMatchState();
  }

  function updateMapTokenVisuals(tIdx, pIdx) {
    const tokens = document.querySelectorAll(`.placed-token[data-ref="${tIdx}-${pIdx}"]`);
    const isDead = teams[tIdx].players[pIdx].status === 'dead';
    tokens.forEach(tok => {
      if(isDead) tok.classList.add('token-dead');
      else tok.classList.remove('token-dead');
    });
  }

  function updateTokenVisuals(tIdx, pIdx) {
      const tokens = document.querySelectorAll(`.placed-token[data-ref="${tIdx}-${pIdx}"]`);
      const player = teams[tIdx].players[pIdx];
      const loadout = player.loadout || {};
      
      tokens.forEach(div => {
          // Update Wep Badge
          let wepBadge = div.querySelector('.wep-badge');
          if(!wepBadge && loadout.wep) {
              wepBadge = document.createElement('div');
              wepBadge.className = 'wep-badge';
              div.appendChild(wepBadge);
          }
          if(wepBadge) wepBadge.innerText = loadout.wep || "";
          if(!loadout.wep && wepBadge) wepBadge.remove();

          // Update Spec Icon
          let specBadge = div.querySelector('.spec-badge');
          if(!specBadge && loadout.spec && specIcons[loadout.spec]) {
              specBadge = document.createElement('div');
              specBadge.className = 'spec-badge';
              div.appendChild(specBadge);
          }
          if(specBadge && loadout.spec && specIcons[loadout.spec]) {
              specBadge.style.backgroundImage = `url('${specIcons[loadout.spec]}')`;
          }
          if((!loadout.spec || !specIcons[loadout.spec]) && specBadge) specBadge.remove();
      });
  }

  // --- MAP & DRAG ---
  function loadMap(src) {
    const img = document.getElementById('map-img');
    img.onload = () => {
       const cvs = document.getElementById('draw-layer');
       cvs.width = img.naturalWidth; cvs.height = img.naturalHeight;
       resetView();
    };
    img.src = src;
    document.getElementById('icon-layer').innerHTML = ''; 
    clearDraw();
    timelineSteps = []; 
    currentStepIndex = 0;
    addTimelineStep(); 
  }

  let dragPayload = null;
  
  function handleDragStart(e) {
    const t = e.target.closest('.player-row');
    const tIdx = t.dataset.tidx;
    const pIdx = t.dataset.pidx;
    const player = teams[tIdx].players[pIdx];
    
    dragPayload = {
        type: 'player', tIdx: tIdx, pIdx: pIdx,
        label: player.c, bg: teams[tIdx].color, name: player.n
    };
    
    if(e.dataTransfer) {
        e.dataTransfer.setData('json', JSON.stringify(dragPayload));
        e.dataTransfer.setData('mode', 'new');
    }
  }

  function addTouchDragSupport(el) {
    el.addEventListener('touchstart', (e) => {
        if(el.dataset.type === 'gadget' || el.dataset.type === 'obj') {
            dragPayload = {
                type: el.dataset.type,
                name: el.dataset.name,
                src: el.dataset.src
            };
        } else if (el.classList.contains('player-row')) {
            const tIdx = el.dataset.tidx;
            const pIdx = el.dataset.pidx;
            const player = teams[tIdx].players[pIdx];
            dragPayload = {
                type: 'player', tIdx: tIdx, pIdx: pIdx,
                label: player.c, bg: teams[tIdx].color, name: player.n
            };
        }
    }, {passive: true});
  }

  function setupInteractions() {
    const stage = document.getElementById('main-stage');
    
    document.addEventListener('dragstart', e => {
      if(e.target.classList.contains('draggable-item')) {
        dragPayload = {
          type: e.target.dataset.type,
          name: e.target.dataset.name,
          src: e.target.dataset.src
        };
        e.dataTransfer.setData('json', JSON.stringify(dragPayload));
        e.dataTransfer.setData('mode', 'new');
      } else if (e.target.closest('.placed-token')) {
        const tok = e.target.closest('.placed-token');
        e.dataTransfer.setData('mode', 'move');
        e.dataTransfer.setData('id', tok.id);
      }
    });

    const wrapper = document.getElementById('map-wrapper');
    wrapper.addEventListener('dragover', e => e.preventDefault());
    wrapper.addEventListener('drop', e => {
      e.preventDefault();
      const rect = wrapper.getBoundingClientRect();
      const x = (e.clientX - rect.left) / scale;
      const y = (e.clientY - rect.top) / scale;
      
      const mode = e.dataTransfer.getData('mode');
      if(mode === 'new') {
        const raw = e.dataTransfer.getData('json');
        if(raw) createToken(x, y, JSON.parse(raw));
      } else if (mode === 'move') {
        const id = e.dataTransfer.getData('id');
        const el = document.getElementById(id);
        if(el) { el.style.left = x + 'px'; el.style.top = y + 'px'; }
      }
    });

    stage.addEventListener('mousedown', onPointerDown);
    stage.addEventListener('touchstart', onPointerDown, {passive: false});
    document.addEventListener('mousemove', onPointerMove);
    document.addEventListener('touchmove', onPointerMove, {passive: false});
    document.addEventListener('mouseup', onPointerUp);
    document.addEventListener('touchend', onPointerUp);
    stage.addEventListener('wheel', e => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      zoom(delta);
    });
  }

  function createToken(x, y, data) {
    const div = document.createElement('div');
    div.className = 'placed-token';
    div.id = 'tok-' + Date.now() + Math.random().toString(16).slice(2);
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    div.draggable = true;
    div.dataset.json = JSON.stringify(data);
    
    div.onclick = (e) => { e.stopPropagation(); selectTokenForRotation(div.id); };
    div.addEventListener('touchstart', (e) => { e.stopPropagation(); selectTokenForRotation(div.id); isDragging = true; });

    const icon = document.createElement('div');
    icon.className = 'token-icon';

    if(data.type === 'gadget' || data.type === 'obj') {
      icon.style.backgroundImage = `url('${data.src}')`; 
      icon.style.backgroundColor = 'rgba(0,0,0,0.5)';
      icon.style.borderColor = data.name === 'Cashout' ? 'var(--primary)' : 'var(--accent)';
      const label = document.createElement('div');
      label.className = 'token-label';
      label.innerText = data.name;
      div.appendChild(label);
    } 
    else if (data.type === 'player') {
      div.classList.add('player-token');
      div.dataset.ref = `${data.tIdx}-${data.pIdx}`;
      icon.style.backgroundColor = data.bg;
      icon.innerText = data.label;
      icon.style.color = 'white';
      const cone = document.createElement('div');
      cone.className = 'vision-cone';
      div.appendChild(cone);
      if(teams[data.tIdx].players[data.pIdx].status === 'dead') div.classList.add('token-dead');
      
      // Update with current loadout data immediately on creation
      setTimeout(() => updateTokenVisuals(data.tIdx, data.pIdx), 0);
    }

    div.appendChild(icon);
    document.getElementById('icon-layer').appendChild(div);
  }

  // --- TIMELINE / RECORDING SYSTEM ---
  function toggleTimelinePanel() {
      const panel = document.getElementById('timeline-panel');
      const btn = document.getElementById('btn-rec-toggle');
      const help = document.getElementById('rec-info-bar');
      
      panel.classList.toggle('active');
      btn.classList.toggle('active');
      
      if(panel.classList.contains('active')) {
          help.style.display = 'block';
      } else {
          help.style.display = 'none';
      }
  }

  function addTimelineStep() {
      const snapshot = [];
      document.querySelectorAll('.placed-token').forEach(el => {
          snapshot.push({
              id: el.id,
              left: el.style.left,
              top: el.style.top,
              rot: el.dataset.rotation || 0,
              dead: el.classList.contains('token-dead')
          });
      });
      
      if (currentStepIndex < timelineSteps.length - 1) {
          timelineSteps = timelineSteps.slice(0, currentStepIndex + 1);
      }

      timelineSteps.push({
          time: matchTime,
          tokens: snapshot
      });
      
      currentStepIndex = timelineSteps.length - 1;
      updateTimelineUI();
      
      const info = document.getElementById('step-info');
      info.innerText = `Step ${currentStepIndex + 1} Captured!`;
      info.style.color = "var(--accent)";
      setTimeout(() => info.style.color = "#666", 1000);
  }

  function deleteTimelineStep() {
      if(timelineSteps.length <= 1) {
          alert("Cannot delete the start step.");
          return;
      }
      
      // Remove current step
      timelineSteps.splice(currentStepIndex, 1);
      
      // Adjust index
      if(currentStepIndex >= timelineSteps.length) {
          currentStepIndex = timelineSteps.length - 1;
      }
      
      // Render the new current step
      scrubTimeline(currentStepIndex);
      updateTimelineUI();
      
      const info = document.getElementById('step-info');
      info.innerText = `Step Deleted.`;
      info.style.color = "var(--danger)";
      setTimeout(() => info.style.color = "#666", 1000);
  }

  function updateTimelineUI() {
      const scrubber = document.getElementById('timeline-scrubber');
      scrubber.max = Math.max(0, timelineSteps.length - 1);
      scrubber.value = currentStepIndex;
      
      const timeDisplay = document.getElementById('match-time-display');
      let min = Math.floor(matchTime / 60);
      let sec = matchTime % 60;
      timeDisplay.innerText = `${min < 10 ? '0'+min : min}:${sec < 10 ? '0'+sec : sec}`;
  }

  function scrubTimeline(val) {
      currentStepIndex = parseInt(val);
      const step = timelineSteps[currentStepIndex];
      if(!step) return;
      
      matchTime = step.time || 0;
      
      // Apply snapshot
      step.tokens.forEach(data => {
          const el = document.getElementById(data.id);
          if (el) {
              el.style.left = data.left;
              el.style.top = data.top;
              el.dataset.rotation = data.rot;
              
              const cone = el.querySelector('.vision-cone');
              if(cone) cone.style.transform = `translate(-50%, -50%) rotate(${data.rot}deg)`;
              
              if(data.dead) el.classList.add('token-dead');
              else el.classList.remove('token-dead');
          }
      });
      
      updateTimelineUI();
      document.getElementById('step-info').innerText = `Viewing Step ${currentStepIndex + 1}/${timelineSteps.length}`;
  }

  function togglePlay() {
      if(isPlaying) {
          clearInterval(playInterval);
          isPlaying = false;
          document.getElementById('play-btn').innerHTML = `<i data-lucide="play" width="14"></i>`;
      } else {
          isPlaying = true;
          document.getElementById('play-btn').innerHTML = `<i data-lucide="pause" width="14"></i>`;
          
          if(currentStepIndex >= timelineSteps.length - 1) currentStepIndex = 0; 
          
          playInterval = setInterval(() => {
              if(currentStepIndex < timelineSteps.length - 1) {
                  scrubTimeline(currentStepIndex + 1);
              } else {
                  togglePlay(); 
              }
          }, 1500); 
      }
      lucide.createIcons();
  }

  // --- VISION & ROTATION ---
  function selectTokenForRotation(id) {
    activeTokenId = id;
    const el = document.getElementById(id);
    document.getElementById('rotation-control').style.display = 'block';
    
    // Setup controls
    const skullBtn = document.getElementById('skull-control');
    const cone = el.querySelector('.vision-cone');
    const slider = document.getElementById('vision-slider');
    const sizeSlider = document.getElementById('size-slider');
    const cashoutControls = document.getElementById('cashout-controls');
    const ziplineControls = document.getElementById('zipline-controls');

    // Default hidden
    cashoutControls.style.display = 'none';
    ziplineControls.style.display = 'none';
    
    // Reset sliders
    sizeSlider.value = el.dataset.scale || 1;

    if(el.classList.contains('player-token')) {
        skullBtn.classList.remove('disabled');
        slider.disabled = false;
        slider.style.opacity = 1;
        slider.value = el.dataset.rotation || 0;
    } else {
        // If objective, check if cashout
        const label = el.querySelector('.token-label');
        if(label && label.innerText.includes('Cashout')) {
            cashoutControls.style.display = 'block';
        }
        // Check for zipline
        if(label && label.innerText.includes('Zipline')) {
            ziplineControls.style.display = 'block';
        }
        
        skullBtn.classList.add('disabled');
        slider.disabled = true;
        slider.style.opacity = 0.5;
    }
  }

  function closeRotationControl() {
    document.getElementById('rotation-control').style.display = 'none';
    activeTokenId = null;
    ziplineDeployMode = false;
  }

  function deleteActiveToken() {
    if(activeTokenId) {
        const token = document.getElementById(activeTokenId);
        
        // Zipline cleanup
        if(token.dataset.lineId) {
            const line = document.getElementById(token.dataset.lineId);
            if(line) line.remove();
        }
        
        token.remove();
        closeRotationControl();
    }
  }

  function rotateVision(val) {
    if(!activeTokenId) return;
    const el = document.getElementById(activeTokenId);
    el.dataset.rotation = val;
    const cone = el.querySelector('.vision-cone');
    if(cone) cone.style.transform = `translate(-50%, -50%) rotate(${val}deg)`;
  }
  
  function resizeToken(val) {
      if(!activeTokenId) return;
      const el = document.getElementById(activeTokenId);
      el.dataset.scale = val;
      el.style.transform = `translate(-50%, -50%) scale(${val})`;
  }

  // --- MATCH & OBJECTIVE TIMERS ---
  
  function toggleMatchTimer() {
      if(matchTimerInterval) {
          clearInterval(matchTimerInterval);
          matchTimerInterval = null;
      } else {
          matchTimerInterval = setInterval(() => {
              if(matchTimer > 0) {
                  matchTimer--;
                  updateMatchTimerDisplay();
              } else {
                  clearInterval(matchTimerInterval);
              }
          }, 1000);
      }
  }
  
  function toggleTimerMinify(e) {
      const timer = document.getElementById('match-timer-overlay');
      const isMinimized = timer.classList.contains('minimized');
      
      if(!isMinimized && e.target.closest('.timer-controls')) return;
      
      timer.classList.toggle('minimized');
  }
  
  function resetMatchTimer() {
      clearInterval(matchTimerInterval);
      matchTimerInterval = null;
      matchTimer = 600; // Reset to 10 mins
      updateMatchTimerDisplay();
  }
  
  function updateMatchTimerDisplay() {
      let m = Math.floor(matchTimer / 60);
      let s = matchTimer % 60;
      document.getElementById('match-timer-val').innerText = `${m}:${s < 10 ? '0'+s : s}`;
  }
  
  function startTokenTimer(seconds) {
      if(!activeTokenId) return;
      const el = document.getElementById(activeTokenId);
      
      // Remove existing badge if any
      let badge = el.querySelector('.timer-badge');
      if(badge) badge.remove();
      
      badge = document.createElement('div');
      badge.className = 'timer-badge';
      el.appendChild(badge);
      
      let timeLeft = seconds;
      
      if(el.dataset.interval) clearInterval(parseInt(el.dataset.interval));
      
      const interval = setInterval(() => {
          timeLeft--;
          let m = Math.floor(timeLeft / 60);
          let s = timeLeft % 60;
          badge.innerText = `${m}:${s < 10 ? '0'+s : s}`;
          
          if(timeLeft <= 0) {
              clearInterval(interval);
              badge.innerText = "DONE";
              badge.style.color = "var(--success)";
              badge.style.borderColor = "var(--success)";
          }
      }, 1000);
      
      el.dataset.interval = interval;
      closeRotationControl();
  }
  
  function stopTokenTimer() {
      if(!activeTokenId) return;
      const el = document.getElementById(activeTokenId);
      if(el.dataset.interval) clearInterval(parseInt(el.dataset.interval));
      const badge = el.querySelector('.timer-badge');
      if(badge) badge.remove();
      closeRotationControl();
  }
  
  // --- ZIPLINE LOGIC ---
  function deployZipline() {
      ziplineDeployMode = true;
      document.getElementById('main-stage').style.cursor = 'crosshair';
      // Close control to clear UI
      document.getElementById('rotation-control').style.display = 'none';
  }

  // --- MODAL LOADOUT EDIT ---
  function openLoadoutModal(tIdx, pIdx) {
      event.stopPropagation(); // Critical fix for bubbling
      editingPlayerRef = { tIdx, pIdx };
      const player = teams[tIdx].players[pIdx];
      const cls = player.c;
      const classKey = cls === 'L' ? 'Light' : cls === 'M' ? 'Medium' : 'Heavy';
      const cData = classData[classKey];
      
      document.getElementById('loadout-modal-title').innerText = `Edit: ${player.n} (${cls})`;
      
      const sSelect = document.getElementById('modal-spec-select');
      sSelect.innerHTML = createOptions(cData.specs, player.loadout ? player.loadout.spec : '');
      
      const wSelect = document.getElementById('modal-wep-select');
      wSelect.innerHTML = createOptions(cData.weapons, player.loadout ? player.loadout.wep : '');
      
      document.getElementById('loadout-modal').classList.add('active');
  }

  function applyModalLoadout() {
      if(!editingPlayerRef) return;
      const spec = document.getElementById('modal-spec-select').value;
      const wep = document.getElementById('modal-wep-select').value;
      
      updateAnyLoadout(editingPlayerRef.tIdx, editingPlayerRef.pIdx, spec, wep);
      document.getElementById('loadout-modal').classList.remove('active');
  }
  
  function showHelpModal() {
      document.getElementById('help-modal').classList.add('active');
  }

  // --- DRAWING ---
  function getCtx() { return document.getElementById('draw-layer').getContext('2d'); }
  
  function setTool(t) { 
      currentTool = t; 
      // Reset active states
      document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
      
      if(t === 'pen') document.getElementById('btn-pen').classList.add('active');
      if(t === 'arrow') document.getElementById('btn-arrow').classList.add('active');
      if(t === 'eraser') document.getElementById('btn-eraser').classList.add('active');
      
      // Safety reset composite
      const c = getCtx();
      c.globalCompositeOperation = 'source-over';
      
      document.getElementById('main-stage').style.cursor = t ? 'crosshair' : 'default';
  }
  
  function setPresetColor(c) {
      currentDrawColor = c;
      document.getElementById('draw-color').value = c;
      
      // Update visual active state
      document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
      // Find based on color approx
      if(c === '#ffffff') document.getElementById('col-white').classList.add('active');
      if(c === '#d6333e') document.getElementById('col-red').classList.add('active');
      if(c === '#3498db') document.getElementById('col-blue').classList.add('active');
      if(c === '#000000') document.getElementById('col-black').classList.add('active');
  }
  
  // Listen to manual color input changes
  document.getElementById('draw-color').addEventListener('input', (e) => {
      currentDrawColor = e.target.value;
      document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
  });
  
  function clearDraw() { 
      const c = document.getElementById('draw-layer'); 
      const ctx = c.getContext('2d');
      // Ensure composite is normal before clearing to avoid weirdness
      ctx.globalCompositeOperation = 'source-over';
      ctx.clearRect(0, 0, c.width, c.height); 
  }
  function clearTokens() { 
      document.getElementById('icon-layer').innerHTML = ''; 
      document.getElementById('line-layer').innerHTML = ''; // Clear SVG lines
      closeRotationControl(); 
      timelineSteps = []; 
      addTimelineStep();
  }

  function onPointerDown(e) {
    if(e.target.closest('#rotation-control') || e.target.closest('.map-controls') || e.target.closest('#timeline-panel') || e.target.closest('#match-timer-overlay')) return;
    if(e.target.closest('.placed-token')) return; 
    
    // Zipline Deploy
    if(ziplineDeployMode && activeTokenId) {
       const r = document.getElementById('map-wrapper').getBoundingClientRect();
       const ex = (e.clientX - r.left) / scale;
       const ey = (e.clientY - r.top) / scale;
       
       const token = document.getElementById(activeTokenId);
       const sx = parseFloat(token.style.left);
       const sy = parseFloat(token.style.top);
       
       // Create SVG Line
       const svg = document.getElementById('line-layer');
       const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
       
       const lineId = 'line-' + Date.now();
       line.setAttribute('id', lineId);
       line.setAttribute('x1', sx);
       line.setAttribute('y1', sy);
       line.setAttribute('x2', ex);
       line.setAttribute('y2', ey);
       line.setAttribute('stroke', '#fcd116');
       line.setAttribute('stroke-width', 4 / scale);
       line.setAttribute('stroke-dasharray', '10, 10');
       svg.appendChild(line);
       
       // Link line to token
       token.dataset.lineId = lineId;
       
       // NEW: Spawn End Token
       const ziplineEndData = { 
           type: 'gadget', 
           name: 'Zipline End', 
           src: 'https://www.thefinals.wiki/w/images/thumb/4/49/Zipline_Rank_1.png/100px-Zipline_Rank_1.png.webp' 
       };
       createToken(ex, ey, ziplineEndData);
       
       ziplineDeployMode = false;
       document.getElementById('main-stage').style.cursor = 'default';
       activeTokenId = null; // Deselect
       return;
    }

    closeRotationControl();
    isDragging = true;
    const r = document.getElementById('map-wrapper').getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    if(currentTool) {
      startX = (clientX - r.left) / scale;
      startY = (clientY - r.top) / scale;
      ctx = getCtx();
      ctx.beginPath(); // Always start new path to avoid connecting previous lines
      
      // Eraser Logic
      if(currentTool === 'eraser') {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.lineWidth = 25 / scale; // Bigger eraser
      } else {
          ctx.globalCompositeOperation = 'source-over';
          ctx.strokeStyle = currentDrawColor;
          ctx.lineWidth = 4 / scale; 
      }
      
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.moveTo(startX, startY);
    } else {
      startX = clientX - pX; 
      startY = clientY - pY;
    }
  }

  function onPointerMove(e) {
    if(!isDragging) return;
    e.preventDefault(); 
    const r = document.getElementById('map-wrapper').getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    if(currentTool) {
       const mx = (clientX - r.left) / scale;
       const my = (clientY - r.top) / scale;
       if(currentTool === 'pen' || currentTool === 'eraser'){ 
           ctx.lineTo(mx,my); 
           ctx.stroke(); 
       }
    } else {
       pX = clientX - startX; 
       pY = clientY - startY; 
       updateTransform();
    }
  }

  function onPointerUp(e) {
    if(!isDragging) return; 
    isDragging = false;
    
    if(currentTool) {
       const r = document.getElementById('map-wrapper').getBoundingClientRect();
       const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
       const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;

       const mx = (clientX - r.left) / scale;
       const my = (clientY - r.top) / scale;
       if(currentTool === 'arrow') {
           // Ensure we draw arrow in normal mode even if logic was weird
           ctx.globalCompositeOperation = 'source-over';
           ctx.strokeStyle = currentDrawColor; 
           drawArrow(ctx, startX, startY, mx, my);
       }
       ctx.closePath();
       ctx.globalCompositeOperation = 'source-over'; // Reset from eraser
    }
  }

  function drawArrow(ctx,fx,fy,tx,ty){ 
    const head = 20 / scale; 
    const dx=tx-fx, dy=ty-fy, angle=Math.atan2(dy,dx); 
    ctx.beginPath(); // Start fresh path for arrow
    ctx.moveTo(fx,fy); ctx.lineTo(tx,ty); 
    ctx.lineTo(tx-head*Math.cos(angle-Math.PI/6),ty-head*Math.sin(angle-Math.PI/6)); 
    ctx.moveTo(tx,ty); 
    ctx.lineTo(tx-head*Math.cos(angle+Math.PI/6),ty-head*Math.sin(angle+Math.PI/6)); 
    ctx.stroke(); 
  }

  function updateTransform() { 
      document.getElementById('map-wrapper').style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; 
  }
  function resetView() { scale=0.5; pX=0; pY=0; updateTransform(); }
  function zoom(val) { scale*=val; scale = Math.min(Math.max(0.1, scale), 4); updateTransform(); }

  // --- UTILS ---
  function setTab(id) {
    document.querySelectorAll('#sidebar-left .nav-btn, .content-pane').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.querySelectorAll('#sidebar-left .nav-btn').forEach(b => {
        if(b.innerText.toLowerCase().includes(id === 'tools' ? 'map' : id === 'loadout' ? 'strat' : id === 'esports' ? 'esports' : 'data')) b.classList.add('active');
    });
  }

  function loadVideo() {
    const url = document.getElementById('video-url').value;
    document.getElementById('video-frame').src = url;
  }

  function openFullData() { document.getElementById('full-data-modal').classList.add('active'); }
  function closeFullData() { document.getElementById('full-data-modal').classList.remove('active'); }

  function startTimer(seconds) {
      clearInterval(timerInterval);
      let t = seconds;
      const display = document.getElementById('respawn-timer');
      display.style.color = 'var(--accent)';
      
      timerInterval = setInterval(() => {
          t--;
          let m = Math.floor(t/60);
          let s = t%60;
          display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
          if(t <= 0) {
              clearInterval(timerInterval);
              display.innerText = "SPAWN";
              display.style.color = "var(--success)";
          }
      }, 1000);
  }

  function stopTimer() { clearInterval(timerInterval); document.getElementById('respawn-timer').innerText = "00:00"; }

  // --- SAVE/LOAD ---
  function saveLoadoutPreset() {
    const name = document.getElementById('preset-name').value;
    if(!name) return alert('Enter a preset name');
    const data = JSON.stringify(teams[0].players);
    localStorage.setItem('tf_loadout_' + name, data);
    alert('Preset "' + name + '" saved!');
  }

  function loadPresetPrompt() {
    const name = prompt("Enter exact preset name to load:");
    if(!name) return;
    const data = localStorage.getItem('tf_loadout_' + name);
    if(data) {
        teams[0].players = JSON.parse(data);
        renderLoadoutEditor();
        renderMatchState();
    } else {
        alert("Preset not found");
    }
  }

  function showAuthModal() { document.getElementById('auth-modal').classList.add('active'); }
  function handleAuth() {
      const email = document.querySelector('#auth-modal input[type="email"]').value;
      if(email) {
          localStorage.setItem('tf_user', JSON.stringify({email: email}));
          document.querySelector('.auth-btn').innerHTML = `<i data-lucide="check"></i> ${email.split('@')[0]}`;
          document.getElementById('auth-modal').classList.remove('active');
          alert("Coach Account Synced (Simulated)");
      }
  }

  function generateShareLink() {
      const state = {
          teams: teams,
          map: document.getElementById('map-select').value,
          tokens: [],
          timeline: timelineSteps
      };

      document.querySelectorAll('.placed-token').forEach(el => {
          state.tokens.push({
              id: el.id,
              left: el.style.left,
              top: el.style.top,
              rot: el.dataset.rotation || 0,
              data: JSON.parse(el.dataset.json || '{}'),
              isDead: el.classList.contains('token-dead')
          });
      });

      const str = JSON.stringify(state);
      const encoded = btoa(encodeURIComponent(str));
      const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?data=" + encoded;
      
      navigator.clipboard.writeText(newUrl).then(() => {
          alert("Strategy Link Copied!");
      }).catch(() => {
          prompt("Copy this link:", newUrl);
      });
  }

  function loadSharedState(encoded) {
      try {
          const str = decodeURIComponent(atob(encoded));
          const state = JSON.parse(str);
          
          teams = state.teams;
          const ms = document.getElementById('map-select');
          ms.value = state.map;
          loadMap(state.map);
          
          if(state.timeline && state.timeline.length > 0) {
              timelineSteps = state.timeline;
              currentStepIndex = 0;
              scrubTimeline(0);
          } else {
              // Legacy load
              setTimeout(() => {
                  state.tokens.forEach(t => {
                      createToken(parseFloat(t.left), parseFloat(t.top), t.data);
                      const el = document.getElementById(document.getElementById('icon-layer').lastChild.id);
                      if(el) {
                          el.style.left = t.left; el.style.top = t.top;
                          if(t.rot) {
                             el.dataset.rotation = t.rot;
                             const c = el.querySelector('.vision-cone');
                             if(c) c.style.transform = `translate(-50%, -50%) rotate(${t.rot}deg)`;
                          }
                          if(t.isDead) el.classList.add('token-dead');
                      }
                  });
              }, 200);
          }

          renderMatchState();
          renderLoadoutEditor();
          
      } catch(e) {
          console.error("Failed to load shared state", e);
          alert("Error loading shared strategy.");
      }
  }

  // Start
  init();

</script>
</body>
</html>
